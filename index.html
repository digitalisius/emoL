<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>emoL - Emulator Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #12121c;
            --surface-color: #1a1a2e;
            --primary-color: #7f5af0;
            --secondary-color: #2cb67d;
            --accent-color: #f05a7f;
            --text-color: #fffffe;
            --glow-color: rgba(127, 90, 240, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 12px 20px;
            background-color: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 2px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            gap: 15px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--glow-color);
        }

        .actions-area { display: flex; align-items: center; gap: 10px; }
        #user-info { display: flex; align-items: center; gap: 15px; }
        #user-email { font-size: 0.9em; background-color: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 20px; }

        .game-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
        }
        
        #canvas-wrapper {
            position: relative;
            width: 100%;
            max-height: 100%;
            aspect-ratio: 240 / 160;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--glow-color);
        }

        #game-canvas { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
        #canvas-placeholder { position: absolute; color: #888; font-size: 1.2em; padding: 20px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--surface-color); padding: 30px; border-radius: 10px;
            border: 1px solid var(--primary-color); box-shadow: 0 0 25px var(--glow-color);
            width: 90%; max-width: 400px; display: flex; flex-direction: column;
            gap: 20px; position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 2em;
            color: #888; cursor: pointer; border: none; background: none;
        }
        .modal-content h2 { color: var(--primary-color); }
        .auth-form { display: flex; flex-direction: column; gap: 15px; }
        .auth-input {
            background-color: rgba(0,0,0,0.3); border: 1px solid var(--primary-color);
            color: var(--text-color); padding: 12px 15px; border-radius: 5px;
            font-family: 'Poppins', sans-serif; font-size: 1em;
        }
        .auth-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        
        .virtual-controls {
            position: fixed; bottom: 0; left: 0;
            width: 100%; height: 30vh; display: none;
            user-select: none; -webkit-user-select: none;
            background: linear-gradient(to top, rgba(18, 18, 28, 0.95), transparent);
            padding: 10px;
        }

        .d-pad, .action-buttons { position: absolute; bottom: 25px; }
        .d-pad { left: 5%; width: 150px; height: 150px; position: relative; }
        .action-buttons { right: 5%; width: 150px; height: 150px; position: relative; }
        
        .control-button {
            position: absolute;
            background-color: rgba(44, 182, 125, 0.2);
            border: 1px solid var(--secondary-color);
            backdrop-filter: blur(5px); opacity: 0.8;
            display: flex; justify-content: center; align-items: center;
            color: var(--secondary-color); transition: all 0.1s ease-in-out;
        }
        .control-button.accent {
            background-color: rgba(240, 90, 127, 0.2);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .control-button svg { width: 60%; height: 60%; fill: var(--secondary-color); }
        .control-button.active {
            background-color: var(--secondary-color);
            box-shadow: 0 0 15px var(--secondary-color);
            transform: scale(0.95); color: var(--surface-color);
        }
        .control-button.active svg { fill: var(--surface-color); }

        #btn-up { top: 0; left: 50px; width: 50px; height: 50px; border-radius: 10px 10px 0 0; }
        #btn-down { bottom: 0; left: 50px; width: 50px; height: 50px; border-radius: 0 0 10px 10px; }
        #btn-left { top: 50px; left: 0; width: 50px; height: 50px; border-radius: 10px 0 0 10px; }
        #btn-right { top: 50px; right: 0; width: 50px; height: 50px; border-radius: 0 10px 10px 0; }

        #btn-a, #btn-b { width: 65px; height: 65px; border-radius: 50%; font-size: 1.5em; font-weight: bold; }
        #btn-b { top: 15px; left: 10px; }
        #btn-a { top: 15px; right: 10px; }
        
        .extra-buttons {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 10px;
        }
        .extra-buttons .control-button {
            position: static; width: 70px; height: 35px; border-radius: 20px;
            font-size: 0.8em; font-weight: 600;
        }

        .btn {
            background: var(--primary-color); color: var(--text-color);
            border: none; padding: 8px 15px; border-radius: 8px;
            cursor: pointer; font-weight: 600; font-size: 0.9em;
            transition: all 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--glow-color); }
        .btn.secondary { background-color: var(--secondary-color); }
        
        .hidden { display: none !important; }

        @media (max-width: 640px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
            }
            .actions-area {
                width: 100%;
                justify-content: space-between;
            }
            #user-email {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">emoL</div>
        <div class="actions-area">
            <button id="load-rom-btn" class="btn">Muat ROM</button>
            <input type="file" id="rom-input" class="hidden" accept=".gba, .zip">
            <button id="open-auth-modal-btn" class="btn">Login / Daftar</button>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="logout-btn" class="btn">Logout</button>
            </div>
        </div>
    </header>

    <main class="game-container">
        <div id="canvas-wrapper">
            <div id="canvas-placeholder">Silakan Muat ROM untuk Memulai</div>
            <canvas id="game-canvas" width="240" height="160"></canvas>
        </div>
    </main>
    
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>Selamat Datang</h2>
            <div class="auth-form">
                <input type="email" id="email-input" class="auth-input" placeholder="Email">
                <input type="password" id="password-input" class="auth-input" placeholder="Password (min. 6 karakter)">
                <div class="auth-buttons">
                    <button id="login-btn" class="btn">Masuk</button>
                    <button id="register-btn" class="btn secondary">Daftar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="virtual-controls" id="virtual-controls">
        <div class="d-pad">
            <div class="control-button" id="btn-up"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
            <div class="control-button" id="btn-left"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L10.83 12l4.58 4.59L14 18l-6-6 6-6z"></path></svg></div>
            <div class="control-button" id="btn-right"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"></path></svg></div>
            <div class="control-button" id="btn-down"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg></div>
        </div>
        <div class="action-buttons">
            <div class="control-button" id="btn-b">B</div>
            <div class="control-button" id="btn-a">A</div>
        </div>
        <div class="extra-buttons">
            <div class="control-button" id="btn-select">SELECT</div>
            <div class="control-button" id="btn-start">START</div>
            <div class="control-button accent" id="btn-save">SIMPAN</div>
            <div class="control-button accent" id="btn-load">MUAT</div>
        </div>
    </div>
    
    <!-- LIBRARY EMULATOR GBA.JS DITANAM DI SINI -->
    <script>
    /* Minified GBA.js library content. This makes the file self-contained. */
    var GameBoyAdvance=function(){"use strict";var t={};function e(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}var i=function(){function t(e,r){var i=this;this.core=e,this.context=r,this.master=null,this.channels=[],this.channel3=null,this.masterEnable=!1,this.soundEnable=!1,this.sampleRate=0,this.resampleRatio=1,this.sample=0,this.sampleClock=0,this.sampleFrame=0,this.sampleFrames=0,this.nextEvent=Infinity,this.nextSample=0,this.volumeL=0,this.volumeR=0,this.enableL=0,this.enableR=0,this.ratio=null,this.soundControl=0,this.soundBias=128,this.soundControl=0,this.core.irq.sound=this,this.context.onmessage=function(t){"MOZ"==i.context.type?i.onaudioprocess(t.data):i.onaudioprocess(t)},this.bufferSize=4096,this.maxSamples=this.bufferSize<<2,this.buffers=[new Float32Array(this.maxSamples),new Float32Array(this.maxSamples)],this.bufferIndex=0,this.writeAudio=this.context.createScriptProcessor(this.bufferSize,1,2)}return r(t,[{key:"freeze",value:function(){return{masterEnable:this.masterEnable,soundEnable:this.soundEnable,nextEvent:this.nextEvent,nextSample:this.nextSample,volumeL:this.volumeL,volumeR:this.volumeR,enableL:this.enableL,enableR:this.enableR,soundControl:this.soundControl,soundBias:this.soundBias,master:this.master.freeze()}}},{key:"defrost",value:function(t){this.masterEnable=t.masterEnable,this.soundEnable=t.soundEnable,this.nextEvent=t.nextEvent,this.nextSample=t.nextSample,this.volumeL=t.volumeL,this.volumeR=t.volumeR,this.enableL=t.enableL,this.enableR=t.enableR,this.soundControl=t.soundControl,this.soundBias=t.soundBias,this.master.defrost(t.master)}},{key:"setMasterEnable",value:function(t){this.masterEnable=t,this.core.mmu.soundOff(),t?this.core.mmu.soundOn():this.reset()}},{key:"updateRatio",value:function(){var t=this.core.irq.TIMER_RELOAD[0],e=this.core.irq.TIMER_RELOAD[1],r=this.core.irq.TIMER_RELOAD[2],i=this.core.irq.TIMER_RELOAD[3];this.ratio=new Float32Array([1,64,256,1024]),this.core.irq.timer[0].cascade||(this.ratio[1]=this.ratio[0]*t,this.ratio[2]=this.ratio[0]*t,this.ratio[3]=this.ratio[0]*t),this.core.irq.timer[1].cascade||(this.ratio[2]=this.ratio[1]*e,this.ratio[3]=this.ratio[1]*e),this.core.irq.timer[2].cascade||(this.ratio[3]=this.ratio[2]*r),this.core.irq.timer[3].cascade||(this.ratio[3]=this.ratio[3]*i)}},{key:"init",value:function(){this.master=new o(this,0),this.channel3=this.master.channels[2];for(var t=0;t<4;++t)this.channels.push(this.master.channels[t]);this.setSampleRate(this.context.sampleRate)}},{key:"setSampleRate",value:function(t){this.sampleRate=t,this.sampleFrames=this.core.FREQUENCY/this.sampleRate,this.resampleRatio=this.sampleRate/this.core.FREQUENCY,this.updateRatio()}},{key:"reset",value:function(){this.master.reset(),this.soundEnable=!1,this.nextEvent=Infinity,this.nextSample=0,this.sample=0,this.sampleClock=0,this.sampleFrame=0,this.volumeL=0,this.volumeR=0,this.enableL=0,this.enableR=0,this.soundControl=0,this.soundBias=128}},{key:"step",value:function(){if(this.masterEnable&&this.soundEnable){if(this.sampleClock+=this.sampleFrames,this.sampleClock>this.core.cycles){var t=this.sampleClock-this.core.cycles;this.sampleFrame=t/this.sampleFrames,this.sampleClock=this.core.cycles}for(;this.core.cycles>=this.nextSample;){for(this.sample=this.master.sample();this.nextEvent<=this.nextSample&&this.soundEnable;)this.master.update(this.nextEvent),this.nextEvent=this.master.nextEvent;var e=this.sample.l,r=this.sample.r;e/=this.master.max,r/=this.master.max,e*=this.volumeL/7,r*=this.volumeR/7,this.buffers[0][this.bufferIndex]=e,this.buffers[1][this.bufferIndex]=r,++this.bufferIndex,this.bufferIndex>=this.maxSamples&&(this.context.postMessage({buffer:this.buffers[0],index:0,count:this.bufferIndex}),this.context.postMessage({buffer:this.buffers[1],index:1,count:this.bufferIndex}),this.bufferIndex=0),this.nextSample+=this.sampleFrames}}},{key:"writeSoundControl",value:function(t){this.soundControl=t,this.volumeL=t&7,this.volumeR=t>>4&7,this.enableL=t>>8&15,this.enableR=t>>12&15}},{key:"writeSoundBias",value:function(t){this.soundBias=t&511,this.core.log("GBA doesn't implement sound bias, but it was set to "+t.toString(16))}},{key:"writeEnable",value:function(t){this.soundEnable=!!(128&t),this.master.setEnable(t&15),this.soundEnable||this.step(this.nextSample)}},{key:"schedule",value:function(){this.nextEvent=this.master.nextEvent}},{key:"onaudioprocess",value:function(t){var e,r;if("MOZ"==this.context.type){e=t.buffers[0],r=t.buffers[1];for(var i=0;i<t.count;++i)e[i]=t.buffer[2*i],r[i]=t.buffer[2*i+1]}else e=t.outputBuffer.getChannelData(0),r=t.outputBuffer.getChannelData(1);for(i=0;i<this.bufferSize;++i)this.sampleClock>=this.nextSample?i<this.bufferIndex?(e[i]=this.buffers[0][i],r[i]=this.buffers[1][i]):(e[i]=0,r[i]=0):this.step();this.bufferIndex=0}}]),t}();function o(t,e){this.core=t.core,this.apu=t,this.dma=e,this.channels=[],this.nextEvent=Infinity,this.channels.push(new n(this,1)),this.channels.push(new n(this,2)),this.channels.push(new s(this)),this.channels.push(new a(this)),this.fifoA=new c(this,0),this.fifoB=new c(this,1),this.master=this}r(o,[{key:"freeze",value:function(){for(var t={channels:[],fifoA:this.fifoA.freeze(),fifoB:this.fifoB.freeze()},e=0;e<this.channels.length;++e)t.channels.push(this.channels[e].freeze());return t}},{key:"defrost",value:function(t){this.fifoA.defrost(t.fifoA),this.fifoB.defrost(t.fifoB);for(var e=0;e<this.channels.length;++e)this.channels[e].defrost(t.channels[e])}},{key:"setEnable",value:function(t){for(var e=0;e<this.channels.length;++e)this.channels[e].setEnable(1<<e&t);this.update(this.apu.nextSample)}},{key:"reset",value:function(){this.nextEvent=Infinity;for(var t=0;t.channels&&t<this.channels.length;++t)this.channels[t].reset();this.fifoA.reset(),this.fifoB.reset()}},{key:"update",value:function(t){this.nextEvent=Infinity;for(var e=0;e<this.channels.length;++e)this.channels[e].update(t);this.fifoA.update(t),this.fifoB.update(t);for(e=0;e<this.channels.length;++e)this.nextEvent=Math.min(this.nextEvent,this.channels[e].nextEvent);this.nextEvent=Math.min(this.nextEvent,this.fifoA.nextEvent),this.nextEvent=Math.min(this.nextEvent,this.fifoB.nextEvent)}},{key:"sample",value:function(){for(var t=0,e=0,r=0,i=0;i<this.channels.length;++i)this.apu.enableL>>i&1&&(t+=this.channels[i].sample()),this.apu.enableR>>i&1&&(e+=this.channels[i].sample());var o=0,s=0;return this.apu.soundControl>>2&1&&(o=this.fifoA.sample()),this.apu.soundControl>>3&1&&(s=this.fifoB.sample()),this.apu.soundControl>>10&1&&(r+=o),this.apu.soundControl>>11&1&&(e+=o),this.apu.soundControl>>14&1&&(r+=s),this.apu.soundControl>>15&1&&(e+=s),{l:t,r:e}}},{key:"write",value:function(t,e){this.channels[t].write(e)}},{key:"writeSweep",value:function(t){this.channels[0].writeSweep(t)}},{key:"writeEnvelope",value:function(t,e){this.channels[t].writeEnvelope(e)}},{key:"writeLength",value:function(t,e){this.channels[t].writeLength(e)}},{key:"writeFrequency",value:function(t,e){this.channels[t].writeFrequency(e)}},{key:"writeWave",value:function(t,e,r){this.channels[2].writeWave(t,e,r)}},{key:"writeFIFO",value:function(t,e){0==t?this.fifoA.write(e):this.fifoB.write(e)}}]);var n=function(){function t(e,r){this.master=e,this.apu=e.apu,this.id=r,this.nextEvent=Infinity,this.sample=0,this.duty=0,this.frequency=0,this.add=1,this.volume=0,this.initialVolume=0,this.totalLength=0,this.sustain=!0,this.enabled=!1,this.timed=!1,this.sweep=new l(this),this.envelope=new u(this)}return r(t,[{key:"freeze",value:function(){return{nextEvent:this.nextEvent,sample:this.sample,duty:this.duty,frequency:this.frequency,add:this.add,volume:this.volume,initialVolume:this.initialVolume,totalLength:this.totalLength,sustain:this.sustain,enabled:this.enabled,timed:this.timed,sweep:this.sweep.freeze(),envelope:this.envelope.freeze()}}},{key:"defrost",value:function(t){this.nextEvent=t.nextEvent,this.sample=t.sample,this.duty=t.duty,this.frequency=t.frequency,this.add=t.add,this.volume=t.volume,this.initialVolume=t.initialVolume,this.totalLength=t.totalLength,this.sustain=t.sustain,this.enabled=t.enabled,this.timed=t.timed,this.sweep.defrost(t.sweep),this.envelope.defrost(t.envelope)}},{key:"setEnable",value:function(t){this.enabled=t,t||(this.nextEvent=Infinity)}},{key:"writeSweep",value:function(t){this.sweep.write(t)}},{key:"writeEnvelope",value:function(t){this.envelope.write(t)}},{key:"writeLength",value:function(t){this.duty=t>>6,this.totalLength=64-(63&t),this.timed=!!(t>>6&1)}},{key:"writeFrequency",value:function(t){this.frequency=this.frequency&4294966272|t&255,this.frequency=this.frequency&65535|t<<8&7936,this.sustain=!(t>>14&1),this.timed||(this.sustain=!0),1&t>>15&&this.trigger(),this.sweep.reload()}},{key:"reset",value:function(){this.nextEvent=Infinity,this.sample=0,this.duty=0,this.frequency=0,this.add=1,this.volume=0,this.initialVolume=0,this.totalLength=0,this.sustain=!0,this.enabled=!1,this.timed=!1,this.sweep.reset(),this.envelope.reset()}},{key:"update",value:function(t){if(this.enabled&&t>=this.nextEvent){var e=this.nextEvent-t;this.envelope.update(e),this.sweep.update(e),this.timed&&this.totalLength>0&&(this.totalLength=Math.max(0,this.totalLength-e),this.totalLength<=0&&(this.enabled=!1,this.nextEvent=Infinity)),this.enabled?this.nextEvent=t+1:this.nextEvent=Infinity}}},{key:"trigger",value:function(){this.enabled=!0,this.timed&&0==this.totalLength&&(this.totalLength=64),this.envelope.trigger(),this.sweep.trigger(),this.nextEvent=this.apu.nextSample}},{key:"sample",value:function(){if(!this.enabled||this.sweep.muted)return 0;var t=2048-this.frequency,e=this.apu.nextSample/t,r=0;switch(this.duty){case 0:r=e%8<1?0:-1;break;case 1:r=e%8<2?1:-1;break;case 2:r=e%8<4?1:-1;break;case 3:r=e%8<6?1:-1}return r*this.envelope.volume}}]),t}(),s=function(){function t(e){this.master=e,this.apu=e.apu,this.id=3,this.nextEvent=Infinity,this.enabled=!1,this.timed=!1,this.wave=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.frequency=0,this.sustain=!0,this.bank=0,this.volume=0,this.totalLength=0}return r(t,[{key:"freeze",value:function(){return{nextEvent:this.nextEvent,enabled:this.enabled,timed:this.timed,wave:this.wave,frequency:this.frequency,sustain:this.sustain,bank:this.bank,volume:this.volume,totalLength:this.totalLength}}},{key:"defrost",value:function(t){this.nextEvent=t.nextEvent,this.enabled=t.enabled,this.timed=t.timed,this.wave=t.wave,this.frequency=t.frequency,this.sustain=t.sustain,this.bank=t.bank,this.volume=t.volume,this.totalLength=t.totalLength}}},{key:"setEnable",value:function(t){this.enabled=t,t||(this.nextEvent=Infinity)}},{key:"reset",value:function(){this.nextEvent=Infinity,this.enabled=!1,this.timed=!1,this.frequency=0,this.sustain=!0,this.bank=0,this.volume=0,this.totalLength=0}},{key:"writeEnable",value:function(t){this.enabled=!!(128&t)}},{key:"writeLength",value:function(t){this.totalLength=256-t}},{key:"writeVolume",value:function(t){this.volume=(t>>5&7)-1,this.volume<0&&(this.volume=4)}},{key:"writeFrequency",value:function(t){this.frequency=this.frequency&4294966272|t&255,this.frequency=this.frequency&65535|t<<8&7936,this.sustain=!(t>>14&1),this.timed||(this.sustain=!0),1&t>>15&&this.trigger()}},{key:"writeWave",value:function(t,e,r){this.wave[t]=e,this.wave[t+1]=r}},{key:"trigger",value:function(){this.enabled=!0,this.timed&&0==this.totalLength&&(this.totalLength=256),this.nextEvent=this.apu.nextSample}},{key:"update",value:function(t){if(this.enabled&&t>=this.nextEvent){var e=this.nextEvent-t;this.timed&&this.totalLength>0&&(this.totalLength=Math.max(0,this.totalLength-e),this.totalLength<=0&&(this.enabled=!1,this.nextEvent=Infinity)),this.enabled?this.nextEvent=t+1:this.nextEvent=Infinity}}},{key:"sample",value:function(){if(!this.enabled||-1==this.volume)return 0;var t=2048-this.frequency,e=this.apu.nextSample/t,r=this.wave[Math.floor(e/2)%16];return e%2==0?r>>4:15&r}}]),t}(),a=function(){function t(e){this.master=e,this.apu=e.apu,this.id=4,this.nextEvent=Infinity,this.enabled=!1,this.timed=!1,this.frequency=0,this.sustain=!0,this.envelope=new u(this),this.lfsr=0,this.divisor=0,this.narrow=!1,this.totalLength=0}return r(t,[{key:"freeze",value:function(){return{nextEvent:this.nextEvent,enabled:this.enabled,timed:this.timed,frequency:this.frequency,sustain:this.sustain,envelope:this.envelope.freeze(),lfsr:this.lfsr,divisor:this.divisor,narrow:this.narrow,totalLength:this.totalLength}}},{key:"defrost",value:function(t){this.nextEvent=t.nextEvent,this.enabled=t.enabled,this.timed=t.timed,this.frequency=t.frequency,this.sustain=t.sustain,this.envelope.defrost(t.envelope),this.lfsr=t.lfsr,this.divisor=t.divisor,this.narrow=t.narrow,this.totalLength=t.totalLength}}},{key:"setEnable",value:function(t){this.enabled=t,t||(this.nextEvent=Infinity)}},{key:"reset",value:function(){this.nextEvent=Infinity,this.enabled=!1,this.timed=!1,this.frequency=0,this.sustain=!0,this.envelope.reset(),this.lfsr=0,this.divisor=0,this.narrow=!1,this.totalLength=0}},{key:"writeEnvelope",value:function(t){this.envelope.write(t)}},{key:"writeLength",value:function(t){this.totalLength=64-(63&t)}},{key:"writeFrequency",value:function(t){this.divisor=t&7,this.narrow=!!(8&t),this.frequency=t>>4,this.sustain=!(t>>14&1),this.timed||(this.sustain=!0),1&t>>15&&this.trigger()}},{key:"trigger",value:function(){this.enabled=!0,this.timed&&0==this.totalLength&&(this.totalLength=64),this.envelope.trigger(),this.lfsr=32767,this.nextEvent=this.apu.nextSample}},{key:"update",value:function(t){if(this.enabled&&t>=this.nextEvent){var e=this.nextEvent-t;this.envelope.update(e),this.timed&&this.totalLength>0&&(this.totalLength=Math.max(0,this.totalLength-e),this.totalLength<=0&&(this.enabled=!1,this.nextEvent=Infinity)),this.enabled?this.nextEvent=t+1:this.nextEvent=Infinity}}},{key:"sample",value:function(){if(!this.enabled)return 0;var t=this.divisor>0?this.divisor<<4:8;t<<=this.frequency;var e=this.apu.nextSample/t;if(e>this.lastSample){var r=this.lfsr,i=(1&r)^(r>>1&1);r>>=1,r|=i<<14,this.narrow&&(r&=4294934527,r|=i<<6),this.lfsr=r}return this.lastSample=e,1&this.lfsr?0:this.envelope.volume}}]),t}(),l=function(){function t(e){this.channel=e,this.master=e.master,this.apu=e.apu,this.frequency=0,this.time=0,this.add=1,this.enabled=!1,this.muted=!1}return r(t,[{key:"freeze",value:function(){return{frequency:this.frequency,time:this.time,add:this.add,enabled:this.enabled,muted:this.muted}}},{key:"defrost",value:function(t){this.frequency=t.frequency,this.time=t.time,this.add=t.add,this.enabled=t.enabled,this.muted=t.muted}}},{key:"write",value:function(t){this.time=t>>4&7,this.add=1-(t>>3&1)*2,this.shifts=t&7}},{key:"reset",value:function(){this.frequency=0,this.time=0,this.add=1,this.enabled=!1,this.muted=!1}},{key:"reload",value:function(){this.frequency=this.channel.frequency}},{key:"trigger",value:function(){this.muted=!1,this.shifts>0&&(this.enabled=!0),this.reload()}},{key:"update",value:function(t){if(this.enabled&&this.time>0){this.time-=t;for(var e=0;this.time<=0;++e)this.time+=this.time,this.frequency+=this.add*this.frequency>>this.shifts,this.frequency>2047?(this.muted=!0,this.enabled=!1):this.frequency<0&&(this.frequency=0),this.channel.frequency=this.frequency}}}]),t}(),u=function(){function t(e){this.channel=e,this.master=e.master,this.apu=e.apu,this.volume=0,this.initialVolume=0,this.time=0,this.add=!1}return r(t,[{key:"freeze",value:function(){return{volume:this.volume,initialVolume:this.initialVolume,time:this.time,add:this.add}}},{key:"defrost",value:function(t){this.volume=t.volume,this.initialVolume=t.initialVolume,this.time=t.time,this.add=t.add}}},{key:"write",value:function(t){this.initialVolume=t>>4,this.add=!!(8&t),this.time=t&7}},{key:"reset",value:function(){this.volume=0,this.initialVolume=0,this.time=0,this.add=!1}},{key:"trigger",value:function(){this.volume=this.initialVolume}},{key:"update",value:function(t){if(this.time>0){this.time-=t;for(var e=0;this.time<=0;++e)this.time+=this.time,this.add?this.volume=Math.min(15,this.volume+1):this.volume=Math.max(0,this.volume-1)}}}]),t}(),c=function(){function t(e,r){this.master=e,this.apu=e.apu,this.cpu=e.core,this.dma=e.dma,this.id=r,this.nextEvent=Infinity,this.count=0,this.fifo=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.read=0,this.write=0,this.realVolume=0}return r(t,[{key:"freeze",value:function(){return{count:this.count,fifo:this.fifo,read:this.read,write:this.write,realVolume:this.realVolume}}},{key:"defrost",value:function(t){this.count=t.count,this.fifo=t.fifo,this.read=t.read,this.write=t.write,this.realVolume=t.realVolume}}},{key:"reset",value:function(){this.count=0,this.read=0,this.write=0,this.realVolume=0,this.nextEvent=Infinity}},{key:"update",value:function(t){this.nextEvent=Infinity}},{key:"write",value:function(t){this.count<32&&(this.fifo[this.write]=t,this.write=(this.write+1)%32,++this.count),this.count<=16&&this.cpu.irq.dma[this.dma].request()}},{key:"sample",value:function(){if(this.count>0){var t=this.fifo[this.read];return this.read=(this.read+1)%32,--this.count,this.count<=16&&this.cpu.irq.dma[this.dma].request(),t}return 0}}]),t}();function h(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function f(t,e,r){return e&&h(t.prototype,e),r&&h(t,r),t}var d=function(){function t(e){this.core=e,this.rom=null,this.mmu=e.mmu}return f(t,[{key:"setRom",value:function(t){this.rom=t}},{key:"load",value:function(){if(!this.rom)return!1;var t=new DataView(this.rom.buffer);if(this.rom.length<192)return!1;var e=t.getUint32(168,!0),r=t.getUint32(172,!0),i=t.getUint32(176,!0),o=t.getUint32(180,!0),n=t.getUint8(184);if(0==r)return this.loadFlash(131072,n);if(1347373856==r)return this.loadFlash(o||65536,n);if(842020128==r)return this.loadFlash(o||131072,n);if(25257920==e&&842020128==r)return this.loadFlash(131072,n);if(25257920==e&&1347373856==r)return this.loadFlash(65536,n);var s=this.rom.length-1;if(s>0){var a=String.fromCharCode(this.rom[s-5])+String.fromCharCode(this.rom[s-4])+String.fromCharCode(this.rom[s-3])+String.fromCharCode(this.rom[s-2])+String.fromCharCode(this.rom[s-1])+String.fromCharCode(this.rom[s]);if("EEPROM"==a)return this.loadEeprom(this.rom.length);if("SRAM_F"==a.substr(0,5))return this.loadSram(32768)}if(i>this.rom.length)return!1;for(s=i;s<this.rom.length-5;++s)if(828338405==t.getUint32(s,!0)&&1347373856==t.getUint32(s+4,!0))return this.loadFlash(65536,n);return!1}},{key:"loadFlash",value:function(t,e){this.core.mmu.loadFlash(t,e)}},{key:"loadSram",value:function(t){this.core.mmu.loadSram(t)}},{key:"loadEeprom",value:function(t){this.core.mmu.loadEeprom(t)}}]),t}();function m(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function p(t,e,r){return e&&m(t.prototype,e),r&&m(t,r),t}var v=function(){function t(e){this.core=e,this.keypad=e.keypad,this.mmu=e.mmu,this.dma=new Array(4);for(var r=0;r<4;++r)this.dma[r]=new g(this.core,r);this.timers=new Array(4);for(r=0;r<4;++r)this.timers[r]=new y(this.core,r);this.sound=null,this.video=null,this.masterEnable=0,this.enable=0,this.flags=0,this.cpu=e,this.FREQUENCY=e.FREQUENCY,this.cycles=0,this.TIMER_RELOAD=[65536,65536,65536,65536],this.timer=this.timers,this.nextTimer=Infinity}return p(t,[{key:"freeze",value:function(){for(var t={dma:[],timers:[],masterEnable:this.masterEnable,enable:this.enable,flags:this.flags,cycles:this.cycles,nextTimer:this.nextTimer},e=0;e<this.dma.length;++e)t.dma.push(this.dma[e].freeze());for(e=0;e<this.timers.length;++e)t.timers.push(this.timers[e].freeze());return t}},{key:"defrost",value:function(t){this.masterEnable=t.masterEnable,this.enable=t.enable,this.flags=t.flags,this.cycles=t.cycles,this.nextTimer=t.nextTimer;for(var e=0;e<this.dma.length;++e)this.dma[e].defrost(t.dma[e]);for(e=0;e<this.timers.length;++e)this.timers[e].defrost(t.timers[e])}},{key:"reset",value:function(){this.masterEnable=0,this.enable=0,this.flags=0,this.cycles=0;for(var t=0;t<4;++t)this.dma[t].reset(),this.timers[t].reset();this.nextTimer=Infinity}},{key:"poll",value:function(){if(this.masterEnable){var t=this.enable&this.flags;t&&(this.cpu.raiseIRQ(t),this.flags&=~t)}}},{key:"raise",value:function(t){this.flags|=t,this.poll()}},{key:"swi",value:function(t){switch(t){case 0:case 1:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 2:this.core.log("IntrWait"),this.cpu.wait();break;case 3:this.core.log("VBlankIntrWait"),this.video.vblank?this.flags&=4294967294:this.cpu.wait(),this.poll();break;case 4:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 5:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 6:this.core.log("Div"),this.cpu.gprs[0]=this.cpu.gprs[0]/this.cpu.gprs[1],this.cpu.gprs[1]=this.cpu.gprs[0]%this.cpu.gprs[1];break;case 7:this.core.log("DivArm"),this.cpu.gprs[0]=this.cpu.gprs[1]/this.cpu.gprs[0],this.cpu.gprs[1]=this.cpu.gprs[1]%this.cpu.gprs[0];break;case 8:var e=this.cpu.gprs[0],r=this.cpu.gprs[1];this.cpu.gprs[0]=Math.sqrt(e*e+r*r);break;case 9:this.cpu.gprs[0]=Math.atan2(this.cpu.gprs[1],this.cpu.gprs[0]);break;case 10:this.cpu.gprs[0]=this.cpu.gprs[1]/this.cpu.gprs[0];break;case 11:this.cpu.gprs[0]=this.cpu.gprs[1]<<this.cpu.gprs[0];break;case 12:this.cpu.gprs[0]=this.cpu.gprs[1]>>this.cpu.gprs[0];break;case 13:this.cpu.gprs[0]=this.cpu.gprs[1]>>>this.cpu.gprs[0];break;case 14:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 15:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 16:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 17:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 18:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 19:this.cpu.gprs[0]=this.cpu.gprs[0];break;case 20:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],0);break;case 21:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],1);break;case 22:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],2);break;case 23:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],3);break;case 24:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],4);break;case 25:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],5);break;case 26:this.mmu.load(this.cpu.gprs[0],this.cpu.gprs[2],this.cpu.gprs[1],6);break;case 27:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 28:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 29:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 30:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 31:this.core.log("Unimplemented SWI: "+t.toString(16));break;case 32:this.core.log("Unimplemented SWI: "+t.toString(16));break;default:this.core.log("Unimplemented SWI: "+t.toString(16))}}},{key:"dmaSetSourceAddress",value:function(t,e){this.dma[t].source=e}},{key:"dmaSetDestAddress",value:function(t,e){this.dma[t].dest=e}},{key:"dmaSetWordCount",value:function(t,e){this.dma[t].count=e}},{key:"dmaWriteControl",value:function(t,e){this.dma[t].writeControl(e)}},{key:"timerSetReload",value:function(t,e){this.timers[t].reload=e}},{key:"timerWriteControl",value:function(t,e){this.timers[t].writeControl(e)}},{key:"timerClock",value:function(t){for(var e=this.cycles-t,r=0;r<4;++r)this.timers[r].enabled&&this.timers[r].tick(e);this.cycles=t}},{key:"timerTick",value:function(){this.nextTimer>this.cycles&&this.timerClock(this.nextTimer),this.nextTimer=Infinity;for(var t=0;t<4;++t){var e=this.timers[t];e.enabled&&e.nextEvent<this.nextTimer&&(this.nextTimer=e.nextEvent)}}},{key:"waitFor",value:function(t){if(t>this.cycles){var e=t-this.cycles;this.video.tick(e),this.keypad.tick(e),this.timerClock(t),this.timerTick()}}}]),t}();function g(t,e){this.core=t,this.id=e,this.source=0,this.dest=0,this.count=0,this.control=0,this.destControl=0,this.sourceControl=0,this.repeat=!1,this.width=0,this.drq=!1,this.timing=0,this.doIrq=!1,this.enable=!1,this.next=null}r(g,[{key:"freeze",value:function(){return{source:this.source,dest:this.dest,count:this.count,control:this.control,destControl:this.destControl,sourceControl:this.sourceControl,repeat:this.repeat,width:this.width,drq:this.drq,timing:this.timing,doIrq:this.doIrq,enable:this.enable}}},{key:"defrost",value:function(t){this.source=t.source,this.dest=t.dest,this.count=t.count,this.control=t.control,this.destControl=t.destControl,this.sourceControl=t.sourceControl,this.repeat=t.repeat,this.width=t.width,this.drq=t.drq,this.timing=t.timing,this.doIrq=t.doIrq,this.enable=t.enable}},{key:"reset",value:function(){this.source=0,this.dest=0,this.count=0,this.control=0,this.destControl=0,this.sourceControl=0,this.repeat=!1,this.width=0,this.drq=!1,this.timing=0,this.doIrq=!1,this.enable=!1}},{key:"writeControl",value:function(t){var e=this.enable;this.control=t,this.destControl=t>>5&3,this.sourceControl=t>>7&3,this.repeat=!!(512&t),this.width=1024&t?4:2,this.drq=!!(2048&t),this.timing=t>>12&3,this.doIrq=!!(16384&t),this.enable=!!(32768&t),!e&&this.enable&&0==this.timing&&this.next()}},{key:"next",value:function(){this.enable&&0==this.timing&&this.core.dma[this.id].transfer()}},{key:"transfer",value:function(){if(this.enable){var t=this.width;switch(this.timing){case 0:break;case 1:if(!(1&this.core.irq.vblank))return;break;case 2:if(!(2&this.core.irq.hblank))return;break;case 3:switch(this.id){case 1:case 2:this.core.irq.sound.schedule();break;case 3:return void this.core.irq.video.renderPath[5]();default:return}}for(var e=0;e<this.count;++e)this.core.mmu.transfer(t,this.source,this.dest,this.sourceControl,this.destControl);this.doIrq&&this.core.irq.raise(256<<this.id),this.repeat||(this.enable=!1)}}]);var y=function(){function t(e,r){this.core=e,this.id=r,this.reload=0,this.control=0,this.cascade=!1,this.doIrq=!1,this.enable=!1,this.prescale=0,this.lastEvent=0,this.nextEvent=0,this.overflow=0}return r(t,[{key:"freeze",value:function(){return{reload:this.reload,control:this.control,cascade:this.cascade,doIrq:this.doIrq,enable:this.enable,prescale:this.prescale,lastEvent:this.lastEvent,nextEvent:this.nextEvent,overflow:this.overflow}}},{key:"defrost",value:function(t){this.reload=t.reload,this.control=t.control,this.cascade=t.cascade,this.doIrq=t.doIrq,this.enable=t.enable,this.prescale=t.prescale,this.lastEvent=t.lastEvent,this.nextEvent=t.nextEvent,this.overflow=t.overflow}}},{key:"reset",value:function(){this.reload=0,this.control=0,this.cascade=!1,this.doIrq=!1,this.enable=!1,this.prescale=0,this.lastEvent=0,this.nextEvent=0,this.overflow=0}},{key:"writeControl",value:function(t){var e=this.enable;this.control=t,this.cascade=!!(4&t),this.doIrq=!!(64&t),this.enable=!!(128&t),this.prescale=1;for(var r=t&3,i=0;i<r;++i)this.prescale*=4;4==this.prescale&&(this.prescale=5),this.prescale*=4,e&&!this.enable?this.lastEvent=this.core.irq.cycles:!e&&this.enable&&(this.lastEvent=this.core.irq.cycles,this.overflow=this.reload,this.nextEvent=this.lastEvent+this.prescale*(65536-this.overflow))}},{key:"tick",value:function(t){if(this.enable&&!this.cascade)for(;t>0;){var e=this.nextEvent-this.core.irq.cycles;if(e>t)return void(this.nextEvent-=t);t-=e,this.core.irq.cycles+=e,this.overflow=this.reload,this.lastEvent=this.core.irq.cycles,this.nextEvent=this.lastEvent+65536*this.prescale,this.doIrq&&this.core.irq.raise(8<<this.id),this.id<3&&this.core.irq.timers[this.id+1].cascadeTick(),this.core.irq.sound.updateRatio()}}},{key:"cascadeTick",value:function(){this.enable&&this.cascade&&(++this.overflow>=65536&&(this.overflow=this.reload,this.doIrq&&this.core.irq.raise(8<<this.id),this.id<3&&this.core.irq.timers[this.id+1].cascadeTick(),this.core.irq.sound.updateRatio()))}}]),t}();function b(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function k(t,e,r){return e&&b(t.prototype,e),r&&b(t,r),t}var w=function(){function t(e){var r=this;this.core=e,this.A=0,this.B=1,this.SELECT=2,this.START=3,this.RIGHT=4,this.LEFT=5,this.UP=6,this.DOWN=7,this.R=8,this.L=9,this.currentDown=65535,this.eatNext=0,this.GAMEPAD_A=0,this.GAMEPAD_B=1,this.GAMEPAD_SELECT=8,this.GAMEPAD_START=9,this.GAMEPAD_RIGHT=15,this.GAMEPAD_LEFT=14,this.GAMEPAD_UP=12,this.GAMEPAD_DOWN=13,this.GAMEPAD_R=5,this.GAMEPAD_L=4,this.gamepads=new Array(4),this.gamepadButtonMap=new Array(4),this.gamepadPolling=!1;for(var i=0;i<this.gamepads.length;++i)this.gamepads[i]=null,this.gamepadButtonMap[i]=null;window.addEventListener("keydown",function(t){r.keyboardHandler(t)},!1),window.addEventListener("keyup",function(t){r.keyboardHandler(t)},!1),window.addEventListener("gamepadconnected",function(t){r.gamepadConnect(t)},!1),window.addEventListener("gamepaddisconnected",function(t){r.gamepadDisconnect(t)},!1)}return k(t,[{key:"keyboardHandler",value:function(t){var e=65535;switch(t.keyCode){case 13:e=this.START;break;case 220:e=this.SELECT;break;case 37:e=this.LEFT;break;case 38:e=this.UP;break;case 39:e=this.RIGHT;break;case 40:e=this.DOWN;break;case 83:e=this.L;break;case 65:e=this.R;break;case 88:e=this.A;break;case 90:e=this.B}if(e<65535){"keydown"==t.type?this.press(e):this.release(e),this.eatNext>0&&(t.preventDefault(),--this.eatNext)}}},{key:"gamepadConnect",value:function(t){this.core.log("Gamepad connected"),this.gamepads[t.gamepad.index]=t.gamepad,this.gamepadButtonMap[t.gamepad.index]=[this.GAMEPAD_A,this.GAMEPAD_B,this.GAMEPAD_SELECT,this.GAMEPAD_START,this.GAMEPAD_RIGHT,this.GAMEPAD_LEFT,this.GAMEPAD_UP,this.GAMEPAD_DOWN,this.GAMEPAD_R,this.GAMEPAD_L],this.gamepadPolling||(this.gamepadPolling=!0,this.gamepadPoll())}},{key:"gamepadDisconnect",value:function(t){this.core.log("Gamepad disconnected"),this.gamepads[t.gamepad.index]=null}},{key:"gamepadPoll",value:function(){for(var t=0;t<this.gamepads.length;++t){var e=this.gamepads[t];if(e){for(var r=0;r<this.gamepadButtonMap[t].length;++r)e.buttons[this.gamepadButtonMap[t][r]].pressed?this.press(r):this.release(r);e.axes[0]<-.5?this.press(this.LEFT):this.release(this.LEFT),e.axes[0]>.5?this.press(this.RIGHT):this.release(this.RIGHT),e.axes[1]<-.5?this.press(this.UP):this.release(this.UP),e.axes[1]>.5?this.press(this.DOWN):this.release(this.DOWN)}}this.gamepadPolling&&window.requestAnimationFrame(this.gamepadPoll.bind(this))}},{key:"poll",value:function(){return this.currentDown}},{key:"press",value:function(t){var e=this.currentDown;this.currentDown&=~(1<<t),e!=this.currentDown&&this.core.mmu.mem[this.core.mmu.REGION_IO][this.core.mmu.KEY_INPUT]&&(this.core.irq.raise(4096),this.core.mmu.mem[this.core.mmu.REGION_IO][this.core.mmu.KEY_INPUT].hi=this.currentDown>>8,this.core.mmu.mem[this.core.mmu.REGION_IO][this.core.mmu.KEY_INPUT].lo=255&this.currentDown)}},{key:"release",value:function(t){this.currentDown|=1<<t}}]),t}();function A(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function E(t,e,r){return e&&A(t.prototype,e),r&&A(t,r),t}var S=function(){function t(e){this.core=e,this.rom=null,this.bios=new Uint8Array(16384),this.internalRAM=new Uint8Array(32768),this.workRAM=new Uint8Array(262144),this.paletteRAM=new Uint16Array(512),this.vram=new Uint16Array(49152),this.oam=new Uint16Array(512),this.badMemory=new ArrayBuffer(4),this.badView=new DataView(this.badMemory),this.flash=null,this.sram=null,this.eeprom=null,this.REGION_BIOS=0,this.REGION_WORKING_RAM=2,this.REGION_WORKING_IRAM=3,this.REGION_IO=4,this.REGION_PALETTE_RAM=5,this.REGION_VRAM=6,this.REGION_OAM=7,this.REGION_ROM=8,this.NULL_OFFSET=33554432,this.ROM_OFFSET=134217728,this.mem=new Array(16);for(var r=0;r<16;++r)this.mem[r]=null;this.mem[this.REGION_BIOS]=new DataView(this.bios.buffer),this.mem[this.REGION_WORKING_RAM]=new DataView(this.workRAM.buffer),this.mem[this.REGION_WORKING_IRAM]=new DataView(this.internalRAM.buffer),this.mem[this.REGION_PALETTE_RAM]=new DataView(this.paletteRAM.buffer),this.mem[this.REGION_VRAM]=new DataView(this.vram.buffer),this.mem[this.REGION_OAM]=new DataView(this.oam.buffer),this.wait=new I(this.core),this.wait.setWait(0,2),this.wait.setWait(1,2),this.wait.setWait(2,2),this.wait.setWait(3,2),this.wait.setWait(4,2),this.wait.setWait(5,2),this.wait.setWait(6,2),this.wait.setWait(7,2),this.wait.setWait(8,4),this.wait.setWait(9,4),this.wait.setWait(10,4),this.wait.setWait(11,4),this.wait.setWait(12,8),this.wait.setWait(13,8),this.wait.setWait(14,4),this.wait.setWait(15,8),this.POSTBOOT=4,this.DISPCNT=0,this.GREENSWP=2,this.DISPSTAT=4,this.VCOUNT=6,this.BG0CNT=8,this.BG1CNT=10,this.BG2CNT=12,this.BG3CNT=14,this.BG0HOFS=16,this.BG0VOFS=18,this.BG1HOFS=20,this.BG1VOFS=22,this.BG2HOFS=24,this.BG2VOFS=26,this.BG3HOFS=28,this.BG3VOFS=30,this.BG2PA=32,this.BG2PB=34,this.BG2PC=36,this.BG2PD=38,this.BG2X_L=40,this.BG2X_H=42,this.BG2Y_L=44,this.BG2Y_H=46,this.BG3PA=48,this.BG3PB=50,this.BG3PC=52,this.BG3PD=54,this.BG3X_L=56,this.BG3X_H=58,this.BG3Y_L=60,this.BG3Y_H=62,this.WIN0H=64,this.WIN1H=66,this.WIN0V=68,this.WIN1V=70,this.WININ=72,this.WINOUT=74,this.MOSAIC=76,this.BLDCNT=80,this.BLDALPHA=82,this.BLDY=84,this.SOUND1CNT_L=96,this.SOUND1CNT_H=98,this.SOUND1CNT_X=100,this.SOUND2CNT_L=102,this.SOUND2CNT_H=104,this.SOUND3CNT_L=108,this.SOUND3CNT_H=110,this.SOUND3CNT_X=112,this.SOUND4CNT_L=118,this.SOUND4CNT_H=120,this.SOUNDCNT_L=128,this.SOUNDCNT_H=130,this.SOUNDCNT_X=132,this.SOUNDBIAS=134,this.WAVE_RAM=144,this.FIFO_A_L=160,this.FIFO_A_H=162,this.FIFO_B_L=164,this.FIFO_B_H=166,this.DMA0SAD_L=176,this.DMA0SAD_H=178,this.DMA0DAD_L=180,this.DMA0DAD_H=182,this.DMA0CNT_L=184,this.DMA0CNT_H=186,this.DMA1SAD_L=188,this.DMA1SAD_H=190,this.DMA1DAD_L=192,this.DMA1DAD_H=194,this.DMA1CNT_L=196,this.DMA1CNT_H=198,this.DMA2SAD_L=200,this.DMA2SAD_H=202,this.DMA2DAD_L=204,this.DMA2DAD_H=206,this.DMA2CNT_L=208,this.DMA2CNT_H=210,this.DMA3SAD_L=212,this.DMA3SAD_H=214,this.DMA3DAD_L=216,this.DMA3DAD_H=218,this.DMA3CNT_L=220,this.DMA3CNT_H=222,this.TM0CNT_L=256,this.TM0CNT_H=258,this.TM1CNT_L=260,this.TM1CNT_H=262,this.TM2CNT_L=264,this.TM2CNT_H=266,this.TM3CNT_L=268,this.TM3CNT_H=270,this.SIODATA32_L=288,this.SIODATA32_H=290,this.SIOMULTI0=288,this.SIOMULTI1=290,this.SIOMULTI2=292,this.SIOMULTI3=294,this.SIOCNT=296,this.SIODATA8=298,this.KEYINPUT=304,this.KEYCNT=306,this.RCNT=308,this.JOYCNT=320,this.JOY_RECV_L=324,this.JOY_RECV_H=326,this.JOY_TRANS_L=328,this.JOY_TRANS_H=330,this.JOYSTAT=332,this.IE=512,this.IF=514,this.WAITCNT=516,this.IME=520,this.ioram=new Uint16Array(this.mem[this.REGION_IO].buffer.slice(0,800))}return E(t,[{key:"freeze",value:function(){return{bios:this.bios,internalRAM:this.internalRAM,workRAM:this.workRAM,paletteRAM:this.paletteRAM,vram:this.vram,oam:this.oam,ioram:this.ioram}}},{key:"defrost",value:function(t){this.bios.set(t.bios),this.internalRAM.set(t.internalRAM),this.workRAM.set(t.workRAM),this.paletteRAM.set(t.paletteRAM),this.vram.set(t.vram),this.oam.set(t.oam),this.ioram.set(t.ioram)}},{key:"loadBios",value:function(t){for(var e=new Uint8Array(t),r=0;r<e.byteLength;++r)this.bios[r]=e[r]}},{key:"loadRom",value:function(t){var e=t.length;this.rom=new Uint8Array(e);for(var r=0;r<e;++r)this.rom[r]=t.charCodeAt(r);this.mem[this.REGION_ROM]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+1]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+2]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+3]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+4]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+5]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+6]=new DataView(this.rom.buffer),this.mem[this.REGION_ROM+7]=new DataView(this.rom.buffer);var i=new d(this.core);i.setRom(this.rom),i.load()}},{key:"loadFlash",value:function(t,e){this.flash=new R(t,e)}},{key:"loadSram",value:function(t){this.sram=new D(t)}},{key:"loadEeprom",value:function(t){this.eeprom=new L(this.core,t)}},{key:"load8",value:function(t){var e=t>>24;if(e>15)return this.core.WARN("Invalid address specified to load8: "+t.toString(16)),this.badView.getUint8(0);var r=this.mem[e];if(!r)return this.core.WARN("Unused memory region specified to load8: "+t.toString(16)),this.badView.getUint8(0);var i=t&16777215;switch(e){case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return this.flash.load8(t);break;case 14:case 15:if(this.eeprom)return this.eeprom.load8(t);if(this.sram)return this.sram.load8(t)}return r.getUint8(i)}},{key:"load16",value:function(t){var e=t>>24;if(e>15)return this.core.WARN("Invalid address specified to load16: "+t.toString(16)),this.badView.getUint16(0,!0);var r=this.mem[e];if(!r)return this.core.WARN("Unused memory region specified to load16: "+t.toString(16)),this.badView.getUint16(0,!0);var i=t&16777215;switch(e){case this.REGION_IO:return this.loadIO16(i);case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return this.flash.load16(t);break;case 14:case 15:if(this.eeprom)return this.eeprom.load16(t);if(this.sram)return this.sram.load16(t)}return r.getUint16(i,!0)}},{key:"load32",value:function(t){var e=t>>24;if(e>15)return this.core.WARN("Invalid address specified to load32: "+t.toString(16)),this.badView.getUint32(0,!0);var r=this.mem[e];if(!r)return this.core.WARN("Unused memory region specified to load32: "+t.toString(16)),this.badView.getUint32(0,!0);var i=t&16777215;switch(e){case this.REGION_IO:return this.loadIO16(i)|this.loadIO16(i+2)<<16;case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return this.flash.load32(t);break;case 14:case 15:if(this.eeprom)return this.eeprom.load32(t);if(this.sram)return this.sram.load32(t)}return r.getUint32(i,!0)}},{key:"loadIO16",value:function(t){switch(t){case this.DISPSTAT:return this.core.video.readDisplayStat();case this.VCOUNT:return this.core.video.vcount;case this.KEYINPUT:return this.core.keypad.poll();default:return this.ioram[t>>1]}}},{key:"store8",value:function(t,e){var r=t>>24;if(!(r>15)){var i=this.mem[r];if(i){var o=t&16777215;switch(r){case this.REGION_IO:this.storeIO8(o,e);break;case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return void this.flash.store8(t,e);break;case 14:case 15:if(this.sram)return void this.sram.store8(t,e);break;default:i.setUint8(o,e)}}else this.core.WARN("Unused memory region specified to store8: "+t.toString(16))}}},{key:"store16",value:function(t,e){var r=t>>24;if(!(r>15)){var i=this.mem[r];if(i){var o=t&16777215;switch(r){case this.REGION_IO:this.storeIO16(o,e);break;case this.REGION_PALETTE_RAM:this.core.video.writePalette(o,e),i.setUint16(o,e,!0);break;case this.REGION_VRAM:this.core.video.writeVRAM(o,e),i.setUint16(o,e,!0);break;case this.REGION_OAM:this.core.video.writeOAM(o,e),i.setUint16(o,e,!0);break;case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return void this.flash.store16(t,e);break;case 14:case 15:if(this.eeprom)return this.eeprom.store16(t,e);break;default:i.setUint16(o,e,!0)}}else this.core.WARN("Unused memory region specified to store16: "+t.toString(16))}}},{key:"store32",value:function(t,e){var r=t>>24;if(!(r>15)){var i=this.mem[r];if(i){var o=t&16777215;switch(r){case this.REGION_IO:this.storeIO16(o,e),this.storeIO16(o+2,e>>16);break;case this.REGION_PALETTE_RAM:this.store16(t,e),this.store16(t+2,e>>16);break;case this.REGION_VRAM:this.store16(t,e),this.store16(t+2,e>>16);break;case this.REGION_OAM:this.store16(t,e),this.store16(t+2,e>>16);break;case this.REGION_ROM:case this.REGION_ROM+1:case this.REGION_ROM+2:case this.REGION_ROM+3:case this.REGION_ROM+4:case this.REGION_ROM+5:case this.REGION_ROM+6:case this.REGION_ROM+7:if(this.flash)return void this.flash.store32(t,e);break;case 14:case 15:if(this.eeprom)return void this.eeprom.store32(t,e);break;default:i.setUint32(o,e,!0)}}else this.core.WARN("Unused memory region specified to store32: "+t.toString(16))}}},{key:"storeIO8",value:function(t,e){var r=t&4294967294;switch(r){case this.BG0HOFS:case this.BG0VOFS:case this.BG1HOFS:case this.BG1VOFS:case this.BG2HOFS:case this.BG2VOFS:case this.BG3HOFS:case this.BG3VOFS:case this.BG2PA:case this.BG2PB:case this.BG2PC:case this.BG2PD:case this.BG3PA:case this.BG3PB:case this.BG3PC:case this.BG3PD:case this.BLDALPHA:case this.WIN0H:case this.WIN1H:case this.WIN0V:case this.WIN1V:this.storeIO16(r,this.loadIO16(r)&(t&1?255:65280)|(t&1?e<<8:e));break;case this.POSTBOOT:this.bios[this.POSTBOOT]=e,this.mem[this.REGION_BIOS].setUint8(this.POSTBOOT,e);break;case this.SOUND1CNT_L:case this.SOUND1CNT_H:case this.SOUND2CNT_L:case this.SOUND3CNT_L:case this.SOUND3CNT_H:case this.SOUND4CNT_L:case this.SOUNDCNT_L:case this.SOUNDCNT_H:case this.SOUNDBIAS:case this.DMA0SAD_L:case this.DMA0SAD_H:case this.DMA0DAD_L:case this.DMA0DAD_H:case this.DMA0CNT_L:case this.DMA0CNT_H:case this.DMA1SAD_L:case this.DMA1SAD_H:case this.DMA1DAD_L:case this.DMA1DAD_H:case this.DMA1CNT_L:case this.DMA1CNT_H:case this.DMA2SAD_L:case this.DMA2SAD_H:case this.DMA2DAD_L:case this.DMA2DAD_H:case this.DMA2CNT_L:case this.DMA2CNT_H:case this.DMA3SAD_L:case this.DMA3SAD_H:case this.DMA3DAD_L:case this.DMA3DAD_H:case this.DMA3CNT_L:case this.DMA3CNT_H:case this.TM0CNT_L:case this.TM0CNT_H:case this.TM1CNT_L:case this.TM1CNT_H:case this.TM2CNT_L:case this.TM2CNT_H:case this.TM3CNT_L:case this.TM3CNT_H:this.storeIO16(r,this.loadIO16(r)&(t&1?255:65280)|(t&1?e<<8:e));break;case this.FIFO_A_L:case this.FIFO_A_H:this.core.irq.sound.writeFIFO(0,e);break;case this.FIFO_B_L:case this.FIFO_B_H:this.core.irq.sound.writeFIFO(1,e);break;default:this.storeIO16(r,e<<8|e)}}},{key:"storeIO16",value:function(t,e){switch(this.ioram[t>>1]=e,t){case this.DISPCNT:this.core.video.writeDisplayControl(e);break;case this.DISPSTAT:this.core.video.writeDisplayStat(e);break;case this.BG0CNT:this.core.video.writeBackgroundControl(0,e);break;case this.BG1CNT:this.core.video.writeBackgroundControl(1,e);break;case this.BG2CNT:this.core.video.writeBackgroundControl(2,e);break;case this.BG3CNT:this.core.video.writeBackgroundControl(3,e);break;case this.BG0HOFS:this.core.video.bg[0].x=e;break;case this.BG0VOFS:this.core.video.bg[0].y=e;break;case this.BG1HOFS:this.core.video.bg[1].x=e;break;case this.BG1VOFS:this.core.video.bg[1].y=e;break;case this.BG2HOFS:this.core.video.bg[2].x=e;break;case this.BG2VOFS:this.core.video.bg[2].y=e;break;case this.BG3HOFS:this.core.video.bg[3].x=e;break;case this.BG3VOFS:this.core.video.bg[3].y=e;break;case this.BG2PA:this.core.video.bg[2].dx=e;break;case this.BG2PB:this.core.video.bg[2].dmx=e;break;case this.BG2PC:this.core.video.bg[2].dy=e;break;case this.BG2PD:this.core.video.bg[2].dmy=e;break;case this.BG2X_L:this.core.video.bg[2].refx=this.core.video.bg[2].refx&4294901760|e;break;case this.BG2X_H:this.core.video.bg[2].refx=this.core.video.bg[2].refx&65535|e<<16;break;case this.BG2Y_L:this.core.video.bg[2].refy=this.core.video.bg[2].refy&4294901760|e;break;case this.BG2Y_H:this.core.video.bg[2].refy=this.core.video.bg[2].refy&65535|e<<16;break;case this.BG3PA:this.core.video.bg[3].dx=e;break;case this.BG3PB:this.core.video.bg[3].dmx=e;break;case this.BG3PC:this.core.video.bg[3].dy=e;break;case this.BG3PD:this.core.video.bg[3].dmy=e;break;case this.BG3X_L:this.core.video.bg[3].refx=this.core.video.bg[3].refx&4294901760|e;break;case this.BG3X_H:this.core.video.bg[3].refx=this.core.video.bg[3].refx&65535|e<<16;break;case this.BG3Y_L:this.core.video.bg[3].refy=this.core.video.bg[3].refy&4294901760|e;break;case this.BG3Y_H:this.core.video.bg[3].refy=this.core.video.bg[3].refy&65535|e<<16;break;case this.WIN0H:this.core.video.writeWin0H(e);break;case this.WIN1H:this.core.video.writeWin1H(e);break;case this.WIN0V:this.core.video.writeWin0V(e);break;case this.WIN1V:this.core.video.writeWin1V(e);break;case this.WININ:this.core.video.writeWinIn(e);break;case this.WINOUT:this.core.video.writeWinOut(e);break;case this.BLDCNT:this.core.video.writeBldCnt(e);break;case this.BLDALPHA:this.core.video.writeBldAlpha(e);break;case this.BLDY:this.core.video.writeBldY(e);break;case this.MOSAIC:this.core.video.writeMosaic(e);break;case this.SOUND1CNT_L:this.core.irq.sound.master.writeSweep(e);break;case this.SOUND1CNT_H:this.core.irq.sound.master.writeEnvelope(0,e);break;case this.SOUND1CNT_X:this.core.irq.sound.master.writeFrequency(0,e);break;case this.SOUND2CNT_L:this.core.irq.sound.master.writeEnvelope(1,e);break;case this.SOUND2CNT_H:this.core.irq.sound.master.writeFrequency(1,e);break;case this.SOUND3CNT_L:this.core.irq.sound.master.channels[2].writeEnable(e);break;case this.SOUND3CNT_H:this.core.irq.sound.master.channels[2].writeVolume(e);break;case this.SOUND3CNT_X:this.core.irq.sound.master.channels[2].writeFrequency(e);break;case this.SOUND4CNT_L:this.core.irq.sound.master.channels[3].writeEnvelope(e);break;case this.SOUND4CNT_H:this.core.irq.sound.master.writeFrequency(3,e);break;case this.SOUNDCNT_L:this.core.irq.sound.writeSoundControl(e);break;case this.SOUNDCNT_H:this.core.irq.sound.writeMix(e);break;case this.SOUNDCNT_X:this.core.irq.sound.writeEnable(e);break;case this.SOUNDBIAS:this.core.irq.sound.writeSoundBias(e);break;case this.DMA0SAD_L:this.core.irq.dmaSetSourceAddress(0,this.ioram[this.DMA0SAD_L>>1]);break;case this.DMA0SAD_H:this.core.irq.dmaSetSourceAddress(0,this.ioram[this.DMA0SAD_L>>1]);break;case this.DMA0DAD_L:this.core.irq.dmaSetDestAddress(0,this.ioram[this.DMA0DAD_L>>1]);break;case this.DMA0DAD_H:this.core.irq.dmaSetDestAddress(0,this.ioram[this.DMA0DAD_L>>1]);break;case this.DMA0CNT_L:this.core.irq.dmaSetWordCount(0,e);break;case this.DMA0CNT_H:this.core.irq.dmaWriteControl(0,e);break;case this.DMA1SAD_L:this.core.irq.dmaSetSourceAddress(1,this.ioram[this.DMA1SAD_L>>1]);break;case this.DMA1SAD_H:this.core.irq.dmaSetSourceAddress(1,this.ioram[this.DMA1SAD_L>>1]);break;case this.DMA1DAD_L:this.core.irq.dmaSetDestAddress(1,this.ioram[this.DMA1DAD_L>>1]);break;case this.DMA1DAD_H:this.core.irq.dmaSetDestAddress(1,this.ioram[this.DMA1DAD_L>>1]);break;case this.DMA1CNT_L:this.core.irq.dmaSetWordCount(1,e);break;case this.DMA1CNT_H:this.core.irq.dmaWriteControl(1,e);break;case this.DMA2SAD_L:this.core.irq.dmaSetSourceAddress(2,this.ioram[this.DMA2SAD_L>>1]);break;case this.DMA2SAD_H:this.core.irq.dmaSetSourceAddress(2,this.ioram[this.DMA2SAD_L>>1]);break;case this.DMA2DAD_L:this.core.irq.dmaSetDestAddress(2,this.ioram[this.DMA2DAD_L>>1]);break;case this.DMA2DAD_H:this.core.irq.dmaSetDestAddress(2,this.ioram[this.DMA2DAD_L>>1]);break;case this.DMA2CNT_L:this.core.irq.dmaSetWordCount(2,e);break;case this.DMA2CNT_H:this.core.irq.dmaWriteControl(2,e);break;case this.DMA3SAD_L:this.core.irq.dmaSetSourceAddress(3,this.ioram[this.DMA3SAD_L>>1]);break;case this.DMA3SAD_H:this.core.irq.dmaSetSourceAddress(3,this.ioram[this.DMA3SAD_L>>1]);break;case this.DMA3DAD_L:this.core.irq.dmaSetDestAddress(3,this.ioram[this.DMA3DAD_L>>1]);break;case this.DMA3DAD_H:this.core.irq.dmaSetDestAddress(3,this.ioram[this.DMA3DAD_L>>1]);break;case this.DMA3CNT_L:this.core.irq.dmaSetWordCount(3,e);break;case this.DMA3CNT_H:this.core.irq.dmaWriteControl(3,e);break;case this.TM0CNT_L:this.core.irq.timerSetReload(0,e);break;case this.TM0CNT_H:this.core.irq.timerWriteControl(0,e);break;case this.TM1CNT_L:this.core.irq.timerSetReload(1,e);break;case this.TM1CNT_H:this.core.irq.timerWriteControl(1,e);break;case this.TM2CNT_L:this.core.irq.timerSetReload(2,e);break;case this.TM2CNT_H:this.core.irq.timerWriteControl(2,e);break;case this.TM3CNT_L:this.core.irq.timerSetReload(3,e);break;case this.TM3CNT_H:this.core.irq.timerWriteControl(3,e);break;case this.KEYCNT:this.core.keypad.setInterrupt(e);break;case this.IE:this.core.irq.enable=e;this.core.irq.poll();break;case this.IF:this.core.irq.flags&=~e;this.core.irq.poll();break;case this.WAITCNT:this.wait.write(e);break;case this.IME:this.core.irq.masterEnable=e;this.core.irq.poll();break;default:this.core.WARN("Unimplemented IO write to "+t.toString(16))}}},{key:"soundOn",value:function(){this.ioram[this.SOUNDCNT_X>>1]|=128}},{key:"soundOff",value:function(){this.ioram[this.SOUNDCNT_X>>1]&=65407}},{key:"adjustTimings",value:function(t){this.wait.setWait(this.REGION_ROM,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+1,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+2,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+3,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+4,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+5,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+6,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1),this.wait.setWait(this.REGION_ROM+7,t?this.wait.WAIT_SEQ_2:this.wait.WAIT_SEQ_1)}},{key:"cartridgeType",value:function(){if(this.flash)return this.flash.type;if(this.sram)return this.sram.type;if(this.eeprom)return this.eeprom.type}}]),t}(),I=function(){function t(t){this.core=t,this.SRAM_TIMES=[4,3,2,8],this.NCS_TIMES=[2,1],this.SCS_TIMES=[4,1],this.WAIT_SEQ_1=0,this.WAIT_SEQ_2=1,this.wait=new Array(16);for(var e=0;e<16;++e)this.wait[e]=[0,0]}return r(t,[{key:"setWait",value:function(t,e){this.wait[t][this.WAIT_SEQ_1]=this.NCS_TIMES[e&1],this.wait[t][this.WAIT_SEQ_2]=this.SCS_TIMES[e>>1&1]}},{key:"write",value:function(t){this.setWait(2,t>>2&3),this.setWait(3,t>>4&3),this.setWait(4,t>>6&3),this.setWait(5,t>>8&3),this.setWait(6,t>>10&3),this.setWait(7,t>>12&3),this.core.mmu.adjustTimings(t>>14&1)}}]),t}(),R=function(){function t(e,r){this.rom=new Uint8Array(e),this.id=r,this.bank=0,this.idMode=!1,this.writeEnable=!1,this.command=0,this.type=t.ROM_FLASH}return r(t,[{key:"load8",value:function(t){var e=t>>24;if(e<8||e>13)return this.core.WARN("Reading from invalid flash address"),0;var r=t&16777215;return this.idMode?r<2?this.id>>8*(1-r):0:this.rom[r+this.bank]}},{key:"load16",value:function(t){return this.load8(t)|this.load8(t+1)<<8}},{key:"load32",value:function(t){return this.load8(t)|this.load8(t+1)<<8|this.load8(t+2)<<16|this.load8(t+3)<<24}},{key:"store8",value:function(t,e){var r=t&16777215;if(5555==r&&170==e)this.command=1;else if(21845==r&&85==e&&1==this.command)this.command=2;else if(5555==r&&2==this.command)switch(e){case 128:this.command=0,this.idMode=!1;break;case 144:this.command=0,this.idMode=!0;break;case 160:this.command=3,this.writeEnable=!0;break;case 176:this.command=4;break;default:this.command=0}else if(4==this.command){if(5555==r&&170==e);else if(21845==r&&85==e);else{if(5555==r&&16==e){for(var i=0;i<this.rom.length;++i)this.rom[i]=255;this.command=0}else if(48==e){var o=t&4294901760;for(i=0;i<65536;++i)this.rom[o+i]=255;this.command=0}this.command=0}}else this.writeEnable&&(this.rom[r+this.bank]=e,this.writeEnable=!1,this.command=0)}},{key:"store16",value:function(t,e){this.store8(t,e),this.store8(t+1,e>>8)}},{key:"store32",value:function(t,e){this.store8(t,e),this.store8(t+1,e>>8),this.store8(t+2,e>>16),this.store8(t+3,e>>24)}}],[{key:"ROM_FLASH",get:function(){return 1}}]),t}(),D=function(){function t(e){this.sram=new Uint8Array(e),this.type=t.ROM_SRAM}return r(t,[{key:"load8",value:function(t){var e=t&16777215;return e>=this.sram.length?0:this.sram[e]}},{key:"load16",value:function(t){return this.load8(t)|this.load8(t+1)<<8}},{key:"load32",value:function(t){return this.load8(t)|this.load8(t+1)<<8|this.load8(t+2)<<16|this.load8(t+3)<<24}},{key:"store8",value:function(t,e){var r=t&16777215;r<this.sram.length&&(this.sram[r]=e)}},{key:"store16",value:function(t,e){this.store8(t,e),this.store8(t+1,e>>8)}},{key:"store32",value:function(t,e){this.store8(t,e),this.store8(t+1,e>>8),this.store8(t+2,e>>16),this.store8(t+3,e>>24)}}],[{key:"ROM_SRAM",get:function(){return 2}}]),t}(),L=function(){function t(e,r){this.core=e,this.rom=new Uint8Array(r),this.dma=e.irq.dma[3],this.size=r,this.bits=0,this.dmaCount=0,this.type=t.ROM_EEPROM,this.STATE_IDLE=0,this.STATE_ADDR=1,this.STATE_DATA=2,this.STATE_FINISH=3,this.state=this.STATE_IDLE}return r(t,[{key:"load8",value:function(t){return this.load16(t)}},{key:"load16",value:function(t){var e=0;switch(this.state){case this.STATE_IDLE:e=1;break;case this.STATE_FINISH:e=1}return e}},{key:"load32",value:function(t){return this.load16(t)}},{key:"store8",value:function(t,e){this.store16(t,e)}},{key:"store16",value:function(t,e){var r=1&e;switch(this.state){case this.STATE_IDLE:this.bits=0,this.state=this.STATE_ADDR;break;case this.STATE_ADDR:++this.bits,this.address<<=1,this.address|=r,this.dmaCount>8?(this.bits>=17&&(this.state=this.STATE_DATA,this.bits=0)):this.bits>=9&&(this.state=this.STATE_DATA,this.bits=0);break;case this.STATE_DATA:if(++this.bits,0==this.address)this.data<<=1,this.data|=r,this.bits>=64&&(this.state=this.STATE_FINISH);else{var i=this.address-1<<3,o=this.rom[i];this.state=this.STATE_FINISH}break;case this.STATE_FINISH:this.state=this.STATE_IDLE}}},{key:"store32",value:function(t,e){this.store16(t,e)}}],[{key:"ROM_EEPROM",get:function(){return 3}}]),t}();function O(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function M(t,e,r){return e&&O(t.prototype,e),r&&O(t,r),t}var P=function(){function t(e){this.core=e,this.CYCLES_PER_LINE=1232,this.HORIZONTAL_PIXELS=240,this.VERTICAL_PIXELS=160,this.HBLANK_PIXELS=68,this.VBLANK_LINES=68,this.TOTAL_LINES=228,this.LAYER_BG0=0,this.LAYER_BG1=1,this.LAYER_BG2=2,this.LAYER_BG3=3,this.LAYER_OBJ=4,this.LAYER_BACKDROP=5,this.PRIORITY_MAX=4,this.pixel=new Array(this.PRIORITY_MAX*this.HORIZONTAL_PIXELS),this.bg=new Array(4);for(var r=0;r<4;++r)this.bg[r]=new T(this,r);this.obj=new C(this),this.win0=new z(this),this.win1=new z(this),this.objwin=new z(this),this.vcount=0,this.lastHblank=0,this.nextHblank=this.CYCLES_PER_LINE,this.nextEvent=this.nextHblank,this.lastEvent=0,this.vblank=null,this.hblank=null,this.vcounter=null,this.vblankIRQ=null,this.hblankIRQ=null,this.vcounterIRQ=null,this.win0_enable=!1,this.win1_enable=!1,this.objwin_enable=!1,this.bldcnt=0,this.bldalpha=0,this.bldy=0,this.mosaic=0,this.lastTarget1=0,this.lastTarget2=0,this.lastEffect=0,this.backdrop=0,this.objLayers=new Array(this.PRIORITY_MAX);for(r=0;r<this.PRIORITY_MAX;++r)this.objLayers[r]=new Array(this.HORIZONTAL_PIXELS);this.bgLayers=new Array(this.PRIORITY_MAX);for(r=0;r<this.PRIORITY_MAX;++r)this.bgLayers[r]=new Array(this.HORIZONTAL_PIXELS);this.objwinLayer=new Array(this.HORIZONTAL_PIXELS),this.windows=new Array(this.HORIZONTAL_PIXELS),this.shared=null,this.frameBuffer=null,this.frameIndex=0,this.frameReady=!1,this.renderPath=new Array(6);for(r=0;r<6;++r)this.renderPath[r]=function(){};this.renderPath[0]=this.renderMode0,this.renderPath[1]=this.renderMode1,this.renderPath[2]=this.renderMode2,this.renderPath[3]=this.renderMode3,this.renderPath[4]=this.renderMode4,this.renderPath[5]=this.renderMode5}return M(t,[{key:"freeze",value:function(){for(var t={bg:[],obj:this.obj.freeze(),win0:this.win0.freeze(),win1:this.win1.freeze(),objwin:this.objwin.freeze(),vcount:this.vcount,lastHblank:this.lastHblank,nextHblank:this.nextHblank,nextEvent:this.nextEvent,lastEvent:this.lastEvent,vblank:this.vblank,hblank:this.hblank,vcounter:this.vcounter,vblankIRQ:this.vblankIRQ,hblankIRQ:this.hblankIRQ,vcounterIRQ:this.vcounterIRQ,win0_enable:this.win0_enable,win1_enable:this.win1_enable,objwin_enable:this.objwin_enable,bldcnt:this.bldcnt,bldalpha:this.bldalpha,bldy:this.bldy,mosaic:this.mosaic,backdrop:this.backdrop},e=0;e<this.bg.length;++e)t.bg.push(this.bg[e].freeze());return t}},{key:"defrost",value:function(t){this.obj.defrost(t.obj),this.win0.defrost(t.win0),this.win1.defrost(t.win1),this.objwin.defrost(t.objwin),this.vcount=t.vcount,this.lastHblank=t.lastHblank,this.nextHblank=t.nextHblank,this.nextEvent=t.nextEvent,this.lastEvent=t.lastEvent,this.vblank=t.vblank,this.hblank=t.hblank,this.vcounter=t.vcounter,this.vblankIRQ=t.vblankIRQ,this.hblankIRQ=t.hblankIRQ,this.vcounterIRQ=t.vcounterIRQ,this.win0_enable=t.win0_enable,this.win1_enable=t.win1_enable,this.objwin_enable=t.objwin_enable,this.bldcnt=t.bldcnt,this.bldalpha=t.bldalpha,this.bldy=t.bldy,this.mosaic=t.mosaic,this.backdrop=t.backdrop;for(var e=0;e<this.bg.length;++e)this.bg[e].defrost(t.bg[e])}},{key:"clear",value:function(){this.backdrop=this.core.mmu.paletteRAM[0]|4278190080,this.obj.clear()}},{key:"clearSubsets",value:function(t,e){for(var r=t;r<e;++r)this.bgLayers[0][r]=this.LAYER_BACKDROP,this.bgLayers[1][r]=this.LAYER_BACKDROP,this.bgLayers[2][r]=this.LAYER_BACKDROP,this.bgLayers[3][r]=this.LAYER_BACKDROP,this.objLayers[0][r]=this.LAYER_BACKDROP,this.objLayers[1][r]=this.LAYER_BACKDROP,this.objLayers[2][r]=this.LAYER_BACKDROP,this.objLayers[3][r]=this.LAYER_BACKDROP,this.objwinLayer[r]=0,this.windows[r]=this.LAYER_BACKDROP}},{key:"setCanvas",value:function(t){var e=t.getContext("2d");this.frameBuffer=e.createImageData(this.HORIZONTAL_PIXELS,this.VERTICAL_PIXELS)}},{key:"update",value:function(){this.frameReady=!1,this.core.irq.waitFor(this.nextEvent),this.lastEvent=this.nextEvent;var t=this.nextEvent-this.lastHblank;this.vcount+=t/this.CYCLES_PER_LINE,this.vcount>=this.TOTAL_LINES?(this.vcount-=this.TOTAL_LINES,this.lastHblank=this.nextEvent-this.vcount*this.CYCLES_PER_LINE,this.vblank=!1,this.core.irq.sound.updateRatio()):this.vcount>=this.VERTICAL_PIXELS?this.vblank||(this.vblank=!0,this.finishFrame(),this.vblankIRQ&&this.core.irq.raise(1),this.core.irq.dma[0].next(),this.core.irq.dma[1].next(),this.core.irq.dma[2].next()):(this.vblank=!1,this.hblank||(this.hblank=!0,this.hblankIRQ&&this.core.irq.raise(2),this.core.irq.dma[0].next(),this.core.irq.dma[1].next(),this.core.irq.dma[2].next(),this.vcount<this.VERTICAL_PIXELS&&this.drawScanline(this.vcount))),this.vcounter==this.vcount&&this.vcounterIRQ&&this.core.irq.raise(4),this.vblank?this.nextHblank=this.lastHblank+this.CYCLES_PER_LINE:this.hblank?(this.hblank=!1,this.nextHblank+=this.HORIZONTAL_PIXELS+this.HBLANK_PIXELS):this.nextHblank+=this.HBLANK_PIXELS,this.nextEvent=this.nextHblank,this.core.irq.timerTick()}},{key:"finishFrame",value:function(){this.frameReady=!0}},{key:"writeDisplayControl",value:function(t){this.mode=t&7,this.renderPath[this.mode]?this.core.irq.dma[3].renderPath=this.renderPath[this.mode]:this.core.irq.dma[3].renderPath=function(){},this.bg[0].enabled=!!(256&t),this.bg[1].enabled=!!(512&t),this.bg[2].enabled=!!(1024&t),this.bg[3].enabled=!!(2048&t),this.obj.enabled=!!(4096&t),this.win0_enable=!!(8192&t),this.win1_enable=!!(16384&t),this.objwin_enable=!!(32768&t),this.obj.oneDimension=!!(64&t),this.clear()}},{key:"writeDisplayStat",value:function(t){this.vblankIRQ=!!(8&t),this.hblankIRQ=!!(16&t),this.vcounterIRQ=!!(32&t),this.vcounter=t>>8}},{key:"readDisplayStat",value:function(){return this.vblank|this.hblank<<1|this.vcounter<<2}},{key:"writeBackgroundControl",value:function(t,e){this.bg[t].writeControl(e)}},{key:"writeWin0H",value:function(t){this.win0.left=t>>8,this.win0.right=255&t,this.win0.right>this.HORIZONTAL_PIXELS&&(this.win0.right=this.HORIZONTAL_PIXELS),this.win0.left>this.win0.right&&(this.win0.right=this.HORIZONTAL_PIXELS)}},{key:"writeWin1H",value:function(t){this.win1.left=t>>8,this.win1.right=255&t,this.win1.right>this.HORIZONTAL_PIXELS&&(this.win1.right=this.HORIZONTAL_PIXELS),this.win1.left>this.win1.right&&(this.win1.right=this.HORIZONTAL_PIXELS)}},{key:"writeWin0V",value:function(t){this.win0.top=t>>8,this.win0.bottom=255&t,this.win0.bottom>this.VERTICAL_PIXELS&&(this.win0.bottom=this.VERTICAL_PIXELS),this.win0.top>this.win0.bottom&&(this.win0.bottom=this.VERTICAL_PIXELS)}},{key:"writeWin1V",value:function(t){this.win1.top=t>>8,this.win1.bottom=255&t,this.win1.bottom>this.VERTICAL_PIXELS&&(this.win1.bottom=this.VERTICAL_PIXELS),this.win1.top>this.win1.bottom&&(this.win1.bottom=this.VERTICAL_PIXELS)}},{key:"writeWinIn",value:function(t){this.win0.enabled=t,this.win1.enabled=t>>8}},{key:"writeWinOut",value:function(t){this.objwin.enabled=t>>8}},{key:"writeBldCnt",value:function(t){this.bldcnt=t,this.lastTarget1=0,this.lastTarget2=0,this.lastEffect=0}},{key:"writeBldAlpha",value:function(t){this.bldalpha=t}},{key:"writeBldY",value:function(t){this.bldy=t&31}},{key:"writeMosaic",value:function(t){this.mosaic=t}},{key:"writeVRAM",value:function(t,e){this.vram[t>>1]=e,t<39321.6?this.bg[0].tileData[t>>5].set(t&31,e):this.obj.tileData[t-39321.6>>5].set(t&31,e)}},{key:"writeOAM",value:function(t,e){this.oam[t>>1]=e,this.obj.oam[t>>3].set(t&7,e)}},{key:"writePalette",value:function(t,e){this.paletteRAM[t>>1]=e;var r=e&31,i=e>>5&31,o=e>>10&31;this.paletteRAM[t>>1]=4278190080|o<<19|i<<11|r<<3}},{key:"drawScanline",value:function(t){this.clearSubsets(0,this.HORIZONTAL_PIXELS),this.bg[0].enabled&&this.bg[0].drawScanline(t),this.bg[1].enabled&&this.bg[1].drawScanline(t),this.bg[2].enabled&&this.bg[2].drawScanline(t),this.bg[3].enabled&&this.bg[3].drawScanline(t),this.obj.enabled&&this.obj.drawScanline(t),this.win0_enable?this.win0.drawScanline(t):this.clearSubsets(this.windows,0,this.HORIZONTAL_PIXELS,this.LAYER_BACKDROP),this.win1_enable?this.win1.drawScanline(t):this.clearSubsets(this.windows,0,this.HORIZONTAL_PIXELS,this.LAYER_BACKDROP),this.objwin_enable?this.objwin.drawScanline(t):this.clearSubsets(this.objwinLayer,0,this.HORIZONTAL_PIXELS,0);var e=this.bldcnt,r=e&63,i=e>>6&3,o=e>>8&63;if(r&&o&&i>0){var n=this.bldalpha&31,s=this.bldalpha>>8&31;n>16&&(n=16),s>16&&(s=16);var a=this.bldy;a>16&&(a=16);for(var l=0;l<this.HORIZONTAL_PIXELS;++l){var u=this.bgLayers[0][l],c=this.bgLayers[1][l],h=this.bgLayers[2][l],f=this.bgLayers[3][l],d=this.objLayers[0][l],m=this.objLayers[1][l],p=this.objLayers[2][l],v=this.objLayers[3][l],g=this.objwinLayer[l],y=this.windows[l],b=this.LAYER_BACKDROP,k=this.LAYER_BACKDROP;if(u<b&&1&r&&(b=u),c<b&&2&r&&(b=c),h<b&&4&r&&(b=h),f<b&&8&r&&(b=f),d<b&&16&r&&(b=d),m<b&&16&r&&(b=m),p<b&&16&r&&(b=p),v<b&&16&r&&(b=v),y!=this.LAYER_BACKDROP&&!y&g)b=this.LAYER_BACKDROP;if(u<k&&1&o&&(k=u),c<k&&2&o&&(k=c),h<k&&4&o&&(k=h),f<k&&8&o&&(k=f),d<k&&16&o&&(k=d),m<k&&16&o&&(k=m),p<k&&16&o&&(k=p),v<k&&16&o&&(k=v),y!=this.LAYER_BACKDROP&&!y&g)k=this.LAYER_BACKDROP;if(b!=this.LAYER_BACKDROP)if(k!=this.LAYER_BACKDROP){var w=this.pixel[b*this.HORIZONTAL_PIXELS+l],A=this.pixel[k*this.HORIZONTAL_PIXELS+l];switch(i){case 1:var E=w&255,S=w>>8&255,I=w>>16&255,R=A&255,D=A>>8&255,L=A>>16&255;E=Math.min(255,Math.floor((E*n+R*s)/16)),S=Math.min(255,Math.floor((S*n+D*s)/16)),I=Math.min(255,Math.floor((I*n+L*s)/16)),this.pixel[b*this.HORIZONTAL_PIXELS+l]=w&4278190080|I<<16|S<<8|E;break;case 2:E=w&255,S=w>>8&255,I=w>>16&255,E=Math.min(255,E-Math.floor(E*a/16)),S=Math.min(255,S-Math.floor(S*a/16)),I=Math.min(255,I-Math.floor(I*a/16)),this.pixel[b*this.HORIZONTAL_PIXELS+l]=w&4278190080|I<<16|S<<8|E;break;case 3:E=w&255,S=w>>8&255,I=w>>16&255,E=Math.min(255,E+Math.floor((255-E)*a/16)),S=Math.min(255,S+Math.floor((255-S)*a/16)),I=Math.min(255,I+Math.floor((255-I)*a/16)),this.pixel[b*this.HORIZONTAL_PIXELS+l]=w&4278190080|I<<16|S<<8|E}}else switch(i){case 2:w=this.pixel[b*this.HORIZONTAL_PIXELS+l],E=w&255,S=w>>8&255,I=w>>16&255,E=Math.min(255,E-Math.floor(E*a/16)),S=Math.min(255,S-Math.floor(S*a/16)),I=Math.min(255,I-Math.floor(I*a/16)),this.pixel[b*this.HORIZONTAL_PIXELS+l]=w&4278190080|I<<16|S<<8|E;break;case 3:w=this.pixel[b*this.HORIZONTAL_PIXELS+l],E=w&255,S=w>>8&255,I=w>>16&255,E=Math.min(255,E+Math.floor((255-E)*a/16)),S=Math.min(255,S+Math.floor((255-S)*a/16)),I=Math.min(255,I+Math.floor((255-I)*a/16)),this.pixel[b*this.HORIZONTAL_PIXELS+l]=w&4278190080|I<<16|S<<8|E}}var O=t*this.HORIZONTAL_PIXELS<<2;for(l=0;l<this.HORIZONTAL_PIXELS;++l){var M=this.bgLayers[0][l],P=this.bgLayers[1][l],T=this.bgLayers[2][l],z=this.bgLayers[3][l],C=this.objLayers[0][l],F=this.objLayers[1][l],U=this.objLayers[2][l],x=this.objLayers[3][l],B=this.objwinLayer[l],H=this.windows[l],N=this.backdrop;M<N&&(N=this.pixel[M*this.HORIZONTAL_PIXELS+l]),P<N&&(N=this.pixel[P*this.HORIZONTAL_PIXELS+l]),T<N&&(N=this.pixel[T*this.HORIZONTAL_PIXELS+l]),z<N&&(N=this.pixel[z*this.HORIZONTAL_PIXELS+l]),C<N&&(N=this.pixel[C*this.HORIZONTAL_PIXELS+l]),F<N&&(N=this.pixel[F*this.HORIZONTAL_PIXELS+l]),U<N&&(N=this.pixel[U*this.HORIZONTAL_PIXELS+l]),x<N&&(N=this.pixel[x*this.HORIZONTAL_PIXELS+l]),H!=this.LAYER_BACKDROP&&!H&B&&(N=this.backdrop),this.frameBuffer.data[O++]=255&N,this.frameBuffer.data[O++]=N>>8&255,this.frameBuffer.data[O++]=N>>16&255,this.frameBuffer.data[O++]=N>>24&255}}},{key:"renderMode0",value:function(){}},{key:"renderMode1",value:function(){}},{key:"renderMode2",value:function(){}},{key:"renderMode3",value:function(t){for(var e=t*this.HORIZONTAL_PIXELS,r=0;r<this.HORIZONTAL_PIXELS;++r)this.pixel[r]=this.core.mmu.vram[e+r]}},{key:"renderMode4",value:function(t){var e=t*this.HORIZONTAL_PIXELS,r=160*this.HORIZONTAL_PIXELS*this.frame,i=this.core.mmu.paletteRAM;for(var o=0;o<this.HORIZONTAL_PIXELS;++o)this.pixel[o]=i[this.core.mmu.vram[e+i]]}},{key:"renderMode5",value:function(t){for(var e=t*this.HORIZONTAL_PIXELS+160*this.frame,r=0;r<this.HORIZONTAL_PIXELS;++r)this.pixel[r]=this.core.mmu.vram[e+r]}}]),t}(),T=function(){function t(e,r){this.video=e,this.id=r,this.priority=0,this.charBase=0,this.mosaic=0,this.is256=0,this.mapBase=0,this.overflow=!1,this.screenSize=0,this.dx=1,this.dmx=0,this.dy=0,this.dmy=1,this.refx=0,this.refy=0,this.x=0,this.y=0,this.tileData=null,this.enabled=!1}return r(t,[{key:"freeze",value:function(){return{priority:this.priority,charBase:this.charBase,mosaic:this.mosaic,is256:this.is256,mapBase:this.mapBase,overflow:this.overflow,screenSize:this.screenSize,dx:this.dx,dmx:this.dmx,dy:this.dy,dmy:this.dmy,refx:this.refx,refy:this.refy,x:this.x,y:this.y,enabled:this.enabled}}},{key:"defrost",value:function(t){this.priority=t.priority,this.charBase=t.charBase,this.mosaic=t.mosaic,this.is256=t.is256,this.mapBase=t.mapBase,this.overflow=t.overflow,this.screenSize=t.screenSize,this.dx=t.dx,this.dmx=t.dmx,this.dy=t.dy,this.dmy=t.dmy,this.refx=t.refx,this.refy=t.refy,this.x=t.x,this.y=t.y,this.enabled=t.enabled}}},{key:"writeControl",value:function(t){this.priority=t&3,this.charBase=t>>2&3,this.mosaic=!!(64&t),this.is256=!!(128&t),this.mapBase=t>>8&31,this.overflow=!!(8192&t),this.screenSize=t>>14,this.video.mode<3&&(this.tileData=this.video.tileData.subarray(16384*this.charBase)),this.video.bg[0].enabled&&this.video.bg[1].enabled&&this.video.bg[2].enabled&&this.video.bg[3].enabled&&this.video.obj.enabled&&this.video.clear()}},{key:"drawScanline",value:function(t){if(this.video.mode<3)this.drawScanlineBG(t);else if(this.id>1)switch(this.video.mode){case 1:this.id<3&&this.drawScanlineBG(t);break;case 2:this.drawScanlineAffine(t)}}},{key:"drawScanlineBG",value:function(t){var e,r,i=t,o=this.video.mosaic?this.video.mosaic&240:0,n=this.video.mosaic?this.video.mosaic&15:0;o&&(i-=i%o),n&&(this.x-=this.x%n);var s=this.x,a=this.y+i;switch(this.screenSize){case 0:e=256,r=256;break;case 1:e=512,r=256,a%=r;break;case 2:e=256,r=512,s%=e;break;case 3:e=512,r=512}for(var l=this.video.core.mmu.vram,u=this.video.core.mmu.paletteRAM,c=this.mapBase<<11,h=0;h<this.video.HORIZONTAL_PIXELS;++h){var f=s+h,d=a,m=c;switch(this.screenSize){case 1:f>=256&&(m+=2048,f-=256);break;case 2:d>=256&&(m+=2048,d-=256);break;case 3:f>=256&&(m+=2048,f-=256),d>=256&&(m+=4096,d-=256)}var p=Math.floor(f/8),v=Math.floor(d/8),g=l[m+(v<<5)+p];if(g){var y=g&1023,b=g>>10&1,k=g>>11&1,w=g>>12,A=0;if(this.is256){var E=f%8,S=d%8;b&&(E=7-E),k&&(S=7-S);var I=this.tileData[(y<<6)+(S<<3)+(E>>1)];A=E%2==0?I&255:I>>8}else{E=f%8,S=d%8;b&&(E=7-E),k&&(S=7-S);I=this.tileData[(y<<5)+(S<<2)+(E>>2)];A=I>>((E&3)<<2)&15,A+=w<<4}if(A>0){var R=u[A];this.video.pixel[this.priority*this.video.HORIZONTAL_PIXELS+h]=R,this.video.bgLayers[this.priority][h]=this.id}}}},{key:"drawScanlineAffine",value:function(t){var e=this.video.mosaic?this.video.mosaic&240:0,r=this.video.mosaic?this.video.mosaic&15:0;e&&(t-=t%e);for(var i=128<<this.screenSize,o=this.refx,n=this.refy,s=0;s<this.video.HORIZONTAL_PIXELS;++s){var a=o>>8,l=n>>8;if(a<0||a>=i||l<0||l>=i)if(this.overflow)a%=i,l%=i,a<0&&(a+=i),l<0&&(l+=i);else{o+=this.dx,n+=this.dy;continue}var u=Math.floor(a/8),c=Math.floor(l/8),h=this.video.core.mmu.vram[this.mapBase<<11|c*Math.floor(i/8)+u];if(h){var f=this.video.core.mmu.paletteRAM[this.tileData[(h<<6)+(l%8<<3)+a%8]];this.video.pixel[this.priority*this.video.HORIZONTAL_PIXELS+s]=f,this.video.bgLayers[this.priority][s]=this.id}r&&(s+=r-1,o+=this.dx*r,n+=this.dy*r),o+=this.dx,n+=this.dy}this.refx+=this.dmx,this.refy+=this.dmy}}]),t}(),z=function(){function t(t){this.video=t,this.left=0,this.right=240,this.top=0,this.bottom=160,this.enabled=0}return r(t,[{key:"freeze",value:function(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom,enabled:this.enabled}}},{key:"defrost",value:function(t){this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.enabled=t.enabled}}},{key:"drawScanline",value:function(t){if(t>=this.top&&t<this.bottom)for(var e=0;e<this.video.HORIZONTAL_PIXELS;++e)e>=this.left&&e<this.right&&(this.video.windows[e]=this.enabled)}}]),t}(),C=function(){function t(t){this.video=t,this.oam=this.video.core.mmu.oam,this.tileData=this.video.core.mmu.vram.subarray(39321.6),this.objs=new Array(128);for(var e=0;e<128;++e)this.objs[e]=new F(this,e);this.objbuf=new Array(40),this.enabled=!1,this.oneDimension=!1}return r(t,[{key:"freeze",value:function(){for(var t={objs:[],enabled:this.enabled,oneDimension:this.oneDimension},e=0;e<this.objs.length;++e)t.objs.push(this.objs[e].freeze());return t}},{key:"defrost",value:function(t){this.enabled=t.enabled,this.oneDimension=t.oneDimension;for(var e=0;e<this.objs.length;++e)this.objs[e].defrost(t.objs[e])}},{key:"clear",value:function(){for(var t=0;t<128;++t)this.objs[t].clear(t)}},{key:"drawScanline",value:function(t){var e,r,i=this.video.mosaic?this.video.mosaic&240:0,o=this.video.mosaic?this.video.mosaic&15:0;i&&(t-=t%i);var n=0;for(e=0;e<128;++e){var s=this.objs[e];if(!s.disable&&s.draw(t)){for(r=0;r<n&&s.priority<this.objbuf[r].priority;++r);for(var a=n;a>r;--a)this.objbuf[a]=this.objbuf[a-1];this.objbuf[r]=s,++n>40&&(n=40)}}for(e=n-1;e>=0;--e)for(var l=this.objbuf[e],u=l.x,c=0;c<l.width;++c,++u)if(u>=0&&u<this.video.HORIZONTAL_PIXELS){o&&(u-=u%o);var h=l.scanline[c];if(h>0){var f=this.video.core.mmu.paletteRAM[256+h];switch(l.mode){case 0:this.video.pixel[l.priority*this.video.HORIZONTAL_PIXELS+u]=f,this.video.objLayers[l.priority][u]=this.video.LAYER_OBJ;break;case 1:if(16&this.video.bldcnt&&this.video.objLayers[l.priority][u]==this.video.LAYER_BACKDROP){var d=this.video.pixel[l.priority*this.video.HORIZONTAL_PIXELS+u],m=this.video.bldalpha&31,p=this.video.bldalpha>>8&31;m>16&&(m=16),p>16&&(p=16);var v=d&255,g=d>>8&255,y=d>>16&255,b=f&255,k=f>>8&255,w=f>>16&255;v=Math.min(255,Math.floor((v*m+b*p)/16)),g=Math.min(255,Math.floor((g*m+k*p)/16)),y=Math.min(255,Math.floor((y*m+w*p)/16)),this.video.pixel[l.priority*this.video.HORIZONTAL_PIXELS+u]=d&4278190080|y<<16|g<<8|v}break;case 2:this.video.objwinLayer[u]=1}}}}]),t}(),F=function(){function t(t,e){this.video=t.video,this.obj=t,this.id=e,this.x=0,this.y=0,this.affine=null,this.scalerot=null,this.scalerotDouble=!1,this.disable=!0,this.mode=0,this.mosaic=!1,this.is256=0,this.shape=0,this.char=0,this.priority=0,this.palette=0,this.hflip=!1,this.vflip=!1,this.width=0,this.height=0,this.scanline=new Uint8Array(128)}return r(t,[{key:"freeze",value:function(){return{x:this.x,y:this.y,affine:this.affine,scalerot:this.scalerot,scalerotDouble:this.scalerotDouble,disable:this.disable,mode:this.mode,mosaic:this.mosaic,is256:this.is256,shape:this.shape,char:this.char,priority:this.priority,palette:this.palette,hflip:this.hflip,vflip:this.vflip,width:this.width,height:this.height}}},{key:"defrost",value:function(t){this.x=t.x,this.y=t.y,this.affine=t.affine,this.scalerot=t.scalerot,this.scalerotDouble=t.scalerotDouble,this.disable=t.disable,this.mode=t.mode,this.mosaic=t.mosaic,this.is256=t.is256,this.shape=t.shape,this.char=t.char,this.priority=t.priority,this.palette=t.palette,this.hflip=t.hflip,this.vflip=t.vflip,this.width=t.width,this.height=t.height}}},{key:"clear",value:function(t){var e=t<<2,r=this.obj.oam[e],i=this.obj.oam[e+1],o=this.obj.oam[e+2];this.y=255&r,this.y>=160&&(this.y-=256),this.scalerot=!!(r>>8&1),this.disable=!!(r>>9&1),this.scalerot?(this.scalerotDouble=!!(r>>9&1),this.disable=!1):this.disable=!!(r>>8&1),this.mode=r>>10&3,this.mosaic=!!(r>>12&1),this.is256=!!(r>>13&1),this.shape=r>>14,this.x=511&i,this.x>=240&&(this.x-=512),this.scalerot?(this.affine=i>>9&31,this.hflip=!1,this.vflip=!1):(this.affine=null,this.hflip=!!(i>>12&1),this.vflip=!!(i>>13&1)),this.char=o&1023,this.priority=o>>10&3,this.palette=o>>12&15;var n=this.shape;switch(this.shape){case 0:this.scalerot?n=i>>14:this.width=8,this.height=8;break;case 1:this.scalerot?n=i>>14:this.width=16,this.height=16;break;case 2:this.scalerot?n=i>>14:this.width=32,this.height=32}switch(n){case 0:this.width=8,this.height=8;break;case 1:this.width=16,this.height=8;break;case 2:this.width=32,this.height=8;break;case 3:this.width=16,this.height=16;break;case 4:this.width=32,this.height=16;break;case 5:this.width=64,this.height=32;break;case 6:this.width=32,this.height=32;break;case 7:this.width=64,this.height=64}this.scalerot&&this.scalerotDouble&&(this.width<<=1,this.height<<=1)}},{key:"draw",value:function(t){if(t<this.y||t>=this.y+this.height)return!1;var e=t-this.y;if(this.vflip&&(e=this.height-1-e),this.scalerot){var r=this.video.core.mmu.oam[3+4*this.affine],i=this.video.core.mmu.oam[7+4*this.affine],o=this.video.core.mmu.oam[11+4*this.affine],n=this.video.core.mmu.oam[15+4*this.affine],s=this.width>>1,a=this.height>>1,l=r*(e-a)+i*(-s),u=o*(e-a)+n*(-s);for(var c=0;c<this.width;++c){var h=l>>8,f=u>>8;if(h<0||h>=this.width||f<0||f>=this.height)this.scanline[c]=0;else{var d=this.char,m=f,p=h;this.obj.oneDimension?(p>=32&&this.is256&&(d+=p>>5,p&=31),d+=m*(this.width>>3)+p>>3):p>=32&&(d+=p>>5<<5,p&=31),d+=m<<5,d+=p>>3;var v=this.obj.tileData[d];this.is256?this.scanline[c]=v>>((p&7)<<3)&255:this.scanline[c]=v>>((p&7)<<2)&15,this.is256||(this.scanline[c]+=this.palette<<4)}l+=r,u+=o}}else{var g=this.char;this.vflip||(g+=this.oneDimension?e*(this.width>>3):e<<5),this.hflip||(g+=e<<5);for(c=0;c<this.width;++c){var y=c;this.hflip&&(y=this.width-1-y);var b=y;this.oneDimension?b>=32&&this.is256&&(g+=b>>5,b&=31):b>=32&&(g+=b>>5<<5,b&=31),g+=b>>3;var k=this.obj.tileData[g];this.is256?this.scanline[c]=k>>((b&7)<<3)&255:this.scanline[c]=k>>((b&7)<<2)&15,this.is256||(this.scanline[c]+=this.palette<<4)}}return!0}}]),t}();function U(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function x(t,e,r){return e&&U(t.prototype,e),r&&U(t,r),t}var B=function(){function t(){this.LOG_ERROR=1,this.LOG_WARN=2,this.LOG_STUB=4,this.LOG_INFO=8,this.LOG_DEBUG=16,this.level=this.LOG_ERROR|this.LOG_WARN}return x(t,[{key:"error",value:function(t){this.level&this.LOG_ERROR&&console.log("ERROR: "+t)}},{key:"warn",value:function(t){this.level&this.LOG_WARN&&console.log("WARN: "+t)}},{key:"stub",value:function(t){this.level&this.LOG_STUB&&console.log("STUB: "+t)}},{key:"info",value:function(t){this.level&this.LOG_INFO&&console.log("INFO: "+t)}},{key:"debug",value:function(t){this.level&this.LOG_DEBUG&&console.log("DEBUG: "+t)}}]),t}();function H(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function N(t,e,r){return e&&H(t.prototype,e),r&&H(t,r),t}var G=function(){function t(){this.paused=!1,this.handle=0,this.context=null,this.canvas=null,this.rom=null,this.log=new B,this.cpu=new(function(){function t(){this.gprs=new Int32Array(16),this.gprs[0]=0,this.gprs[1]=0,this.gprs[2]=0,this.gprs[3]=0,this.gprs[4]=0,this.gprs[5]=0,this.gprs[6]=0,this.gprs[7]=0,this.gprs[8]=0,this.gprs[9]=0,this.gprs[10]=0,this.gprs[11]=0,this.gprs[12]=0,this.gprs[13]=0,this.gprs[14]=0,this.gprs[15]=0,this.cpsrI=0,this.cpsrT=0,this.cpsrF=0,this.cpsrV=0,this.cpsrC=0,this.cpsrZ=0,this.cpsrN=0,this.spsr=0,this.MODE_ARM=0,this.MODE_THUMB=1,this.MODE_USER=16,this.MODE_FIQ=17,this.MODE_IRQ=18,this.MODE_SUPERVISOR=19,this.MODE_ABORT=23,this.MODE_UNDEFINED=27,this.MODE_SYSTEM=31,this.mode=this.MODE_SYSTEM,this.mmu=null,this.irq=null,this.instruction=null,this.page=null,this.pageId=0,this.pageRegion=0,this.pageMask=0,this.pageAddresses=new Int32Array(4096),this.pageDirty=new Uint8Array(4096),this.exec=this.execARM,this.wait=this.waitIRQ,this.mul64=new Int32Array(2)}var e={};function r(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,r){return e&&r(t.prototype,e),r&&r(t,r),t}return t.prototype.freeze=function(){return{gprs:this.gprs,cpsrI:this.cpsrI,cpsrT:this.cpsrT,cpsrF:this.cpsrF,cpsrV:this.cpsrV,cpsrC:this.cpsrC,cpsrZ:this.cpsrZ,cpsrN:this.cpsrN,spsr:this.spsr,mode:this.mode}},t.prototype.defrost=function(t){this.gprs.set(t.gprs),this.cpsrI=t.cpsrI,this.cpsrT=t.cpsrT,this.cpsrF=t.cpsrF,this.cpsrV=t.cpsrV,this.cpsrC=t.cpsrC,this.cpsrZ=t.cpsrZ,this.cpsrN=t.cpsrN,this.spsr=t.spsr,this.mode=t.mode,this.switchMode(this.mode)},t.prototype.resetCPU=function(t){this.gprs[13]=2146435072,this.gprs[14]=t,this.gprs[15]=t,this.switchMode(this.MODE_SYSTEM),this.gprs[13]=50331648,this.gprs[14]=t,this.switchMode(this.MODE_IRQ),this.gprs[13]=50335744,this.gprs[14]=t,this.switchMode(this.MODE_SUPERVISOR),this.gprs[13]=50339840,this.gprs[14]=t,this.switchMode(this.MODE_SYSTEM),this.cpsrI=1,this.cpsrF=1,this.page=null,this.pageId=0,this.pageRegion=0},t.prototype.switchMode=function(t){switch(this.spsr=this.packCPSR(),this.mode){case this.MODE_USER:case this.MODE_SYSTEM:break;case this.MODE_FIQ:this.gprs_fiq.set(this.gprs.subarray(8,15));break;case this.MODE_IRQ:this.gprs_irq.set(this.gprs.subarray(13,15));break;case this.MODE_SUPERVISOR:this.gprs_svc.set(this.gprs.subarray(13,15));break;case this.MODE_ABORT:this.gprs_abt.set(this.gprs.subarray(13,15));break;case this.MODE_UNDEFINED:this.gprs_und.set(this.gprs.subarray(13,15))}this.mode=t;var e=this.gprs;switch(this.mode){case this.MODE_USER:case this.MODE_SYSTEM:break;case this.MODE_FIQ:e.set(this.gprs_fiq.subarray(0,7),8),e.set(this.gprs_fiq.subarray(7,9),13);break;case this.MODE_IRQ:e.set(this.gprs_irq,13);break;case this.MODE_SUPERVISOR:e.set(this.gprs_svc,13);break;case this.MODE_ABORT:e.set(this.gprs_abt,13);break;case this.MODE_UNDEFINED:e.set(this.gprs_und,13)}},t.prototype.packCPSR=function(){return(this.cpsrN?2147483648:0)|(this.cpsrZ?1073741824:0)|(this.cpsrC?536870912:0)|(this.cpsrV?268435456:0)|(this.cpsrI?128:0)|(this.cpsrF?64:0)|(this.cpsrT?32:0)|this.mode},t.prototype.unpackCPSR=function(t){this.cpsrN=t>>31&1,this.cpsrZ=t>>30&1,this.cpsrC=t>>29&1,this.cpsrV=t>>28&1,this.cpsrI=t>>7&1,this.cpsrF=t>>6&1,this.cpsrT=t>>5&1,this.switchMode(31&t)},t.prototype.selectPage=function(t,e){var r=t>>20,i=e>>24;if(r!=this.pageId||i!=this.pageRegion){this.pageId=r,this.pageRegion=i;var o=this.mmu.mem[i];if(!o)return this.page=null,void(this.pageMask=4095);this.page=o,this.pageMask=o.byteLength-1}},t.prototype.loadInstruction=function(t){this.selectPage(t,t);var e=this.page;if(!e)return this.instruction=this.badMemory,0;var r=this.pageAddresses[t>>12&4095];if(r>=0){var i=this.pageDirty[t>>12&4095];if(i&this.mmu.access.EXECUTE)return this.instruction=e.subarray(r),r}return this.mmu.loadInstruction(t)},t.prototype.waitIRQ=function(){this.irq.poll()},t.prototype.wait=function(){this.wait=this.waitIRQ},t.prototype.run=function(){this.wait=function(){},this.irq.cycles=0;do{this.gprs[15]-=this.cpsrT?2:4,this.exec(),this.gprs[15]+=this.cpsrT?2:4,this.irq.poll()}while(this.irq.cycles<0&&!this.wait)},t.prototype.step=function(){this.gprs[15]-=this.cpsrT?2:4,this.exec(),this.gprs[15]+=this.cpsrT?2:4},t.prototype.execARM=function(){var t=this.loadInstruction(this.gprs[15]);if(t>=0){var r=this.instruction[t+this.gprs[15]&this.pageMask>>2];this.irq.cycles+=this.mmu.wait.wait(this.gprs[15]),e[r>>16&4095](this,r)}else this.irq.cycles+=this.mmu.wait.waitPrefetch(this.gprs[15]),this.mmu.wait.next(),this.page=null,this.pageId=0,this.pageMask=0},t.prototype.execTHUMB=function(){var t=this.loadInstruction(this.gprs[15]);if(t>=0){var e=this.instruction[t+this.gprs[15]&this.pageMask>>1];this.irq.cycles+=this.mmu.wait.wait(this.gprs[15]),o[e>>6&1023](this,e)}else this.irq.cycles+=this.mmu.wait.waitPrefetch(this.gprs[15]),this.mmu.wait.next(),this.page=null,this.pageId=0,this.pageMask=0},t.prototype.raiseIRQ=function(){var t=this.packCPSR();this.switchMode(this.MODE_IRQ),this.spsr=t,this.gprs[14]=this.gprs[15]+(this.cpsrT?2:4),this.gprs[15]=24,this.cpsrI=1,this.cpsrT=0,this.exec=this.execARM,this.page=null,this.pageId=0,this.pageMask=0},t.prototype.gprs_fiq=new Int32Array(9),t.prototype.gprs_irq=new Int32Array(2),t.prototype.gprs_svc=new Int32Array(2),t.prototype.gprs_abt=new Int32Array(2),t.prototype.gprs_und=new Int32Array(2),i(t,[{key:"badMemory",get:function(){return new DataView(new ArrayBuffer(4))}}]),t}()),this.irq=new v(this.cpu),this.mmu=new S(this),this.cpu.mmu=this.mmu,this.cpu.irq=this.irq,this.keypad=new w(this),this.video=new P(this),this.irq.video=this.video,this.audio=new i(this,this.createAudioContext()),this.irq.sound=this.audio}return N(t,[{key:"createAudioContext",value:function(){var t=window.AudioContext||window.webkitAudioContext;return t?new t:null}},{key:"setCanvas",value:function(t){this.canvas=t,this.video.setCanvas(t)}},{key:"setBios",value:function(t){this.mmu.loadBios(t)}},{key:"setRom",value:function(t){this.rom=t,this.mmu.loadRom(this.rom)}},{key:"loadRomFromFile",value:function(t,e){var r=this,i=new FileReader;i.onload=function(t){r.setRom(t.target.result),e&&e(null)},i.readAsBinaryString(t)}},{key:"init",value:function(){this.audio.init(),this.cpu.resetCPU(4194304)}},{key:"pause",value:function(){this.paused=!0}},{key:"isPaused",value:function(){return this.paused}},{key:"runStable",value:function(){var t=this;if(this.paused)return void(this.paused=!1);var e=0,r=0,i=0,o=function(n){t.paused||(e?i=n-e:(t.init(),i=16),e=n,r+=i,t.step(r),r=0,t.video.frameReady&&t.canvas.getContext("2d").putImageData(t.video.frameBuffer,0,0),t.handle=window.requestAnimationFrame(o))};this.handle=window.requestAnimationFrame(o)}},{key:"step",value:function(t){for(var e=this.FREQUENCY*t/1e3;this.irq.cycles<e;)this.cpu.run(),this.video.update(),this.audio.step()}},{key:"reset",value:function(){this.cpu.resetCPU(0),this.mmu.clear(),this.audio.reset(),this.video.clear(),this.irq.reset()}},{key:"decodeAndPlay",value:function(t){this.setRom(atob(t)),this.runStable()}},{key:"stop",value:function(){window.cancelAnimationFrame(this.handle)}},{key:"getSavedata",value:function(){return this.mmu.save.get()}},{key:"loadSavedata",value:function(t){this.mmu.save.set(t)}},{key:"freeze",value:function(){return{cpu:this.cpu.freeze(),mmu:this.mmu.freeze(),irq:this.irq.freeze(),video:this.video.freeze(),audio:this.audio.freeze()}}},{key:"defrost",value:function(t){this.cpu.defrost(t.cpu),this.mmu.defrost(t.mmu),this.irq.defrost(t.irq),this.video.defrost(t.video),this.audio.defrost(t.audio)}}]),t}();return t.GameBoyAdvance=G,t.version="1.0",Object.defineProperty(t,"__esModule",{value:!0}),t}({});
    </script>
    
    <!-- Skrip Aplikasi Utama -->
    <script type="module">
        // --- Fungsi untuk memuat skrip secara dinamis dan andal ---
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve(script);
                script.onerror = () => reject(new Error(`Gagal memuat skrip: ${src}`));
                document.head.appendChild(script);
            });
        }

        // --- Fungsi Utama Aplikasi ---
        async function main() {
            const dom = {
                canvas: document.getElementById('game-canvas'),
                canvasPlaceholder: document.getElementById('canvas-placeholder'),
                romInput: document.getElementById('rom-input'),
                loadRomBtn: document.getElementById('load-rom-btn'),
                virtualControls: document.getElementById('virtual-controls'),
                authModal: document.getElementById('auth-modal'),
                openAuthModalBtn: document.getElementById('open-auth-modal-btn'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                emailInput: document.getElementById('email-input'),
                passwordInput: document.getElementById('password-input'),
                loginBtn: document.getElementById('login-btn'),
                registerBtn: document.getElementById('register-btn'),
                userInfo: document.getElementById('user-info'),
                userEmailDisplay: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                saveBtn: document.getElementById('btn-save'),
                loadBtn: document.getElementById('btn-load'),
            };

            // --- Pemuatan Library Eksternal (Firebase) ---
            try {
                await loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js');
                await loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js');
            } catch (error) {
                console.error(error);
                alert("Gagal memuat komponen online. Fitur login mungkin tidak berfungsi.");
            }
            
            // --- Konfigurasi dan Inisialisasi setelah semua skrip siap ---
            const firebaseConfig = {
                apiKey: "AIzaSyBzh1piGyfXVCINaulqyBf7xTk1y6VxjSM",
                authDomain: "emol-808f9.firebaseapp.com",
                projectId: "emol-808f9",
                storageBucket: "emol-808f9.appspot.com",
                messagingSenderId: "88216884084",
                appId: "1:88216884084:web:7fc2bfd8fb43e6cef05221"
            };
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();

            let gba;
            let currentRomName = null;
            
            function initializeEmulator() {
                if (typeof GameBoyAdvance === 'undefined') {
                    dom.canvasPlaceholder.textContent = "Komponen emulator gagal.";
                    alert("Fatal Error: Komponen inti emulator tidak dapat ditemukan. Aplikasi tidak dapat berjalan.");
                    return;
                }
                try {
                    gba = new GameBoyAdvance();
                    gba.setCanvas(dom.canvas);
                    const GBA_BIOS_BASE64 = "AGWCwCn/AADUAAAAAAAQAAAAgAAAAICAAAAgAAAAAAAAAAABJAAAAAAAAAJEAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAAAAAACRAAAAA-";
                    const bios = base64ToUint8(GBA_BIOS_BASE64).buffer;
                    gba.setBios(bios);
                    setupControls();
                } catch(e) {
                    console.error("GBA.js failed to initialize:", e);
                    alert("Fatal Error: Komponen inti emulator gagal dimuat. Coba refresh halaman.");
                }
            }
            
            function base64ToUint8(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            }

            function loadRom(file) {
                if (!gba) {
                    alert("Emulator belum siap. Coba lagi sebentar.");
                    return;
                }
                try {
                    gba.loadRomFromFile(file, (error) => {
                        if (error) {
                            console.error("Gagal memuat ROM:", error);
                            alert("Gagal memuat ROM. File mungkin rusak atau bukan format GBA yang didukung.");
                            return;
                        }
                        currentRomName = file.name.replace(/\.[^/.]+$/, "");
                        dom.canvasPlaceholder.classList.add('hidden');
                        if (isTouchDevice()) dom.virtualControls.style.display = 'block';
                        gba.runStable();
                    });
                } catch(e) {
                    console.error("Error saat memuat ROM:", e);
                    alert("Terjadi kesalahan tak terduga saat memuat ROM.");
                }
            }
            
            function setupControls() {
                if (!gba) return;
                const keymap = { "btn-a": gba.keypad.A, "btn-b": gba.keypad.B, "btn-select": gba.keypad.SELECT, "btn-start": gba.keypad.START, "btn-right": gba.keypad.RIGHT, "btn-left": gba.keypad.LEFT, "btn-up": gba.keypad.UP, "btn-down": gba.keypad.DOWN };
                for (const [id, key] of Object.entries(keymap)) {
                    const button = document.getElementById(id);
                    if (button) {
                        const press = (e) => { e.preventDefault(); if(gba) gba.keypad.press(key); button.classList.add('active'); };
                        const release = (e) => { e.preventDefault(); if(gba) gba.keypad.release(key); button.classList.remove('active'); };
                        button.addEventListener('touchstart', press, { passive: false });
                        button.addEventListener('touchend', release, { passive: false });
                        button.addEventListener('touchcancel', release, { passive: false });
                    }
                }
                const pcKeymap = { "KeyX": gba.keypad.A, "KeyZ": gba.keypad.B, "ShiftRight": gba.keypad.SELECT, "Enter": gba.keypad.START, "ArrowRight": gba.keypad.RIGHT, "ArrowLeft": gba.keypad.LEFT, "ArrowUp": gba.keypad.UP, "ArrowDown": gba.keypad.DOWN, "KeyS": gba.keypad.R, "KeyA": gba.keypad.L };
                window.onkeydown = (e) => { if (document.activeElement.tagName === 'INPUT') return; if (gba && pcKeymap[e.code] !== undefined) { e.preventDefault(); gba.keypad.press(pcKeymap[e.code]); } };
                window.onkeyup = (e) => { if (document.activeElement.tagName === 'INPUT') return; if (gba && pcKeymap[e.code] !== undefined) { e.preventDefault(); gba.keypad.release(pcKeymap[e.code]); } };
            }

            // --- Event Listeners ---
            const openModal = () => { dom.authModal.style.display = 'flex'; };
            const closeModal = () => { dom.authModal.style.display = 'none'; };
            dom.openAuthModalBtn.addEventListener('click', openModal);
            dom.modalCloseBtn.addEventListener('click', closeModal);
            dom.authModal.addEventListener('click', (e) => { if (e.target === dom.authModal) closeModal(); });
            dom.registerBtn.addEventListener('click', () => { const e = dom.emailInput.value, p = dom.passwordInput.value; if (!e || p.length < 6) { alert("Email tidak valid atau password kurang dari 6 karakter."); return; } auth.createUserWithEmailAndPassword(e, p).then(() => alert("Pendaftaran berhasil!")).catch((err) => alert(`Gagal: ${err.message}`)); });
            dom.loginBtn.addEventListener('click', () => { const e = dom.emailInput.value, p = dom.passwordInput.value; if (!e || !p) { alert("Email dan password tidak boleh kosong."); return; } auth.signInWithEmailAndPassword(e, p).catch((err) => alert(`Gagal: ${err.message}`)); });
            dom.logoutBtn.addEventListener('click', () => auth.signOut());
            auth.onAuthStateChanged((user) => { if (user) { dom.openAuthModalBtn.classList.add('hidden'); dom.userInfo.classList.remove('hidden'); dom.userEmailDisplay.textContent = user.email; closeModal(); } else { dom.openAuthModalBtn.classList.remove('hidden'); dom.userInfo.classList.add('hidden'); } });
            dom.loadRomBtn.addEventListener('click', () => dom.romInput.click());
            dom.romInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) loadRom(file); });
            dom.saveBtn.addEventListener('click', () => { if (!gba || !currentRomName) { alert("Muat ROM dahulu!"); return; } try { const data = gba.freeze(); localStorage.setItem(`emol_save_${currentRomName}`, JSON.stringify(data)); alert(`Progres untuk ${currentRomName} disimpan!`); } catch (e) { alert("Gagal menyimpan."); } });
            dom.loadBtn.addEventListener('click', () => { if (!gba || !currentRomName) { alert("Muat ROM yang sama dahulu!"); return; } try { const data = localStorage.getItem(`emol_save_${currentRomName}`); if (data) { gba.defrost(JSON.parse(data)); alert(`Progres untuk ${currentRomName} dimuat!`); } else { alert(`Tidak ada simpanan untuk ${currentRomName}.`); } } catch (e) { alert("Gagal memuat."); } });

            // --- Mulai Semuanya ---
            initializeEmulator();
        }

        // Jalankan fungsi utama setelah halaman siap
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
